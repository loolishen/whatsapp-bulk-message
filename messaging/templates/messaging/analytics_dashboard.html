{% load static %}
{% load analytics_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analytics — WhatsApp Campaigns</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===== Facebook CRM Design System ===== */
    :root{
      --fb-blue:#1877f2; --fb-blue-hover:#166fe5; --fb-blue-light:#e7f3ff;
      --fb-gray:#f0f2f5; --fb-gray-dark:#65676b; --fb-gray-light:#f8f9fa;
      --fb-white:#ffffff; --fb-black:#1c1e21; --fb-text:#1c1e21;
      --fb-success:#42b883; --fb-warning:#f7b731; --fb-danger:#e74c3c;
      --fb-border:#dadde1; --fb-shadow:0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);
      --fb-radius:8px; --fb-radius-lg:12px;
    }
    *{box-sizing:border-box; margin:0; padding:0}
    body{background:var(--fb-gray); color:var(--fb-text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; line-height:1.4}

    /* ===== Facebook-style Top Navigation ===== */
    .topbar{
      background:var(--fb-white); border-bottom:1px solid var(--fb-border);
      position:sticky; top:0; z-index:1000; box-shadow:0 1px 2px rgba(0,0,0,0.1)
    }
    .topbar__inner{
      max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between;
      padding:8px 16px; height:56px
    }
    .brand{
      display:flex; align-items:center; gap:8px; text-decoration:none; font-weight:700; font-size:20px
    }
    .brand__logo{
      width:40px; height:40px; border-radius:50%; background:var(--fb-blue);
      display:flex; align-items:center; justify-content:center; color:white; font-weight:800
    }
    .brand__text{color:var(--fb-text)}

    .nav-tabs{
      display:flex; gap:8px; align-items:center; flex:1; justify-content:center
    }
    .nav-tab{
      padding:8px 16px; border-radius:var(--fb-radius); text-decoration:none; font-weight:600;
      color:var(--fb-gray-dark); transition:all 0.2s; position:relative
    }
    .nav-tab:hover{background:var(--fb-gray-light); color:var(--fb-text)}
    .nav-tab.active{color:var(--fb-blue); background:var(--fb-blue-light)}
    .nav-tab.active::after{
      content:''; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%);
      width:100%; height:3px; background:var(--fb-blue); border-radius:2px
    }

    .topbar-actions{
      display:flex; gap:8px; align-items:center
    }
    .action-btn{
      width:40px; height:40px; border-radius:50%; background:var(--fb-gray-light);
      border:none; display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:background 0.2s; color:var(--fb-gray-dark)
    }
    .action-btn:hover{background:var(--fb-border)}
    .user-avatar{
      width:32px; height:32px; border-radius:50%; background:var(--fb-blue);
      display:flex; align-items:center; justify-content:center; color:white;
      font-weight:600; font-size:14px
    }

    /* ===== Main Layout ===== */
    .main-container{max-width:1200px; margin:0 auto; padding:20px 16px; display:flex; gap:24px}
    .sidebar{width:240px; background:var(--fb-white); border-radius:var(--fb-radius-lg); box-shadow:var(--fb-shadow); padding:20px; height:fit-content; position:sticky; top:80px}
    .main-content{flex:1; min-width:0}
    .page-header{margin-bottom:24px}
    .page-title{font-size:28px; font-weight:700; color:var(--fb-text); margin-bottom:8px}
    .page-subtitle{color:var(--fb-gray-dark); font-size:16px}
    
    /* ===== Sidebar Navigation ===== */
    .sidebar-title{font-size:16px; font-weight:600; color:var(--fb-text); margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid var(--fb-border)}
    .sidebar-nav{list-style:none; padding:0; margin:0}
    .sidebar-nav li{margin-bottom:4px}
    .sidebar-nav a{display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:var(--fb-radius); text-decoration:none; color:var(--fb-gray-dark); font-weight:500; transition:all 0.2s}
    .sidebar-nav a:hover{background:var(--fb-gray-light); color:var(--fb-text)}
    .sidebar-nav a.active{background:var(--fb-blue-light); color:var(--fb-blue); font-weight:600}
    .sidebar-nav a svg{width:18px; height:18px; flex-shrink:0}

    /* ===== Facebook-style Cards ===== */
    .card{
      background:var(--fb-white); border-radius:var(--fb-radius-lg); box-shadow:var(--fb-shadow);
      border:1px solid var(--fb-border); margin-bottom:16px
    }
    .card-header{
      padding:16px 20px; border-bottom:1px solid var(--fb-border);
      display:flex; align-items:center; justify-content:space-between
    }
    .card-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .card-body{padding:20px}

    /* ===== Stats Grid ===== */
    .stats-grid{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px; margin-bottom:24px
    }
    .stat-card{
      background:var(--fb-white); border-radius:var(--fb-radius-lg); padding:20px;
      box-shadow:var(--fb-shadow); border:1px solid var(--fb-border)
    }
    .stat-value{font-size:32px; font-weight:700; color:var(--fb-text); margin-bottom:4px}
    .stat-label{color:var(--fb-gray-dark); font-size:14px; font-weight:500}
    .stat-change{
      font-size:12px; font-weight:600; margin-top:8px; display:flex; align-items:center; gap:4px
    }
    .stat-change.positive{color:var(--fb-success)}
    .stat-change.negative{color:var(--fb-danger)}

    /* ===== Charts Grid ===== */
    .charts-grid{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));
      gap:20px; margin-bottom:24px
    }
    .chart{height:320px}
    .chart-small{height:240px}

    /* ===== Table ===== */
    .table-container{background:var(--fb-white); border-radius:var(--fb-radius-lg); overflow:hidden; box-shadow:var(--fb-shadow)}
    .table-header{
      padding:16px 20px; border-bottom:1px solid var(--fb-border);
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px
    }
    .table-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .table-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .data-table{
      width:100%; border-collapse:collapse; font-size:14px
    }
    .data-table th{
      background:var(--fb-gray-light); padding:12px 16px; text-align:left;
      font-weight:600; color:var(--fb-text); border-bottom:1px solid var(--fb-border)
    }
    .data-table td{
      padding:12px 16px; border-bottom:1px solid var(--fb-border); vertical-align:middle
    }
    .data-table tbody tr:hover{background:var(--fb-gray-light)}

    .badge{
      display:inline-block; padding:4px 8px; border-radius:12px;
      font-size:12px; font-weight:600; background:var(--fb-gray-light); color:var(--fb-text)
    }

    /* ===== Period Selector ===== */
    .period-selector{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:20px
    }
    .period-btn{
      padding:8px 16px; border:1px solid var(--fb-border); background:var(--fb-white);
      border-radius:var(--fb-radius); font-weight:600; cursor:pointer; transition:all 0.2s
    }
    .period-btn:hover{background:var(--fb-gray-light)}
    .period-btn.active{background:var(--fb-blue); color:white; border-color:var(--fb-blue)}

    /* ===== Responsive Design ===== */
    @media (max-width:768px){
      .topbar__inner{flex-direction:column; height:auto; padding:12px 16px; gap:12px}
      .nav-tabs{order:2; width:100%; justify-content:center; flex-wrap:wrap}
      .topbar-actions{order:3}
      .main-container{padding:16px 12px; flex-direction:column}
      .sidebar{width:100%; position:static; margin-bottom:16px}
      .main-content{flex:1}
      .page-title{font-size:24px}
      .stats-grid{grid-template-columns:1fr}
      .charts-grid{grid-template-columns:1fr}
      .table-header{flex-direction:column; align-items:stretch}
      .table-actions{justify-content:center}
    }
  </style>
</head>
<body>
  <!-- ===== Facebook-style Top Navigation ===== -->
  <nav class="topbar">
    <div class="topbar__inner">
      <!-- Brand -->
      <a href="{% url 'dashboard' %}" class="brand">
        <div class="brand__logo">WA</div>
        <div class="brand__text">Campaign</div>
      </a>

      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <a href="{% url 'contest_home' %}" class="nav-tab">Contest</a>
        <a href="{% url 'crm_home' %}" class="nav-tab">CRM</a>
      </div>

      <!-- Actions -->
      <div class="topbar-actions">
        <button class="action-btn" title="Export">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 20h16M12 4v12m0 0 4-4m-4 4-4-4"/>
          </svg>
        </button>
        <a href="{% url 'auth_logout' %}" class="action-btn" title="Logout">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
            <path d="M16 17l5-5-5-5"/>
            <path d="M21 12H9"/>
          </svg>
        </a>
        <div class="user-avatar" title="You">{{ request.user.first_name|default:"U"|slice:":1"|upper }}</div>
      </div>
    </div>
  </nav>

  <!-- ===== Main Content ===== -->
  <div class="main-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <h3 class="sidebar-title">Analytics</h3>
      <ul class="sidebar-nav">
        <li>
          <a href="{% url 'analytics_dashboard' %}" class="active">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </svg>
            Overview
          </a>
        </li>
        <li>
          <a href="{% url 'crm_analytics' %}">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            CRM Analytics
          </a>
        </li>
        <li>
          <a href="{% url 'contest_analytics' %}">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Contest Analytics
          </a>
        </li>
      </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <h1 class="page-title">Analytics Overview</h1>
      <p class="page-subtitle">Insights across contacts, delivery, engagement and participation</p>
    </div>

    <!-- Period Selector -->
    <div class="period-selector">
      <button class="period-btn active" data-range="30d">Last 30 days</button>
      <button class="period-btn" data-range="90d">Last 90 days</button>
      <button class="period-btn" data-range="12m">Last 12 months</button>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ total_contacts|default:0 }}</div>
        <div class="stat-label">Total Contacts</div>
        <div class="stat-change positive">+{{ recent_additions|default:0 }} this month</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ unique_states|default:0 }}</div>
        <div class="stat-label">States Represented</div>
        <div class="stat-change positive">{{ cross_tab_races|length|default:0 }} races tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ unique_events|default:0 }}</div>
        <div class="stat-label">Events (Sources)</div>
        <div class="stat-change positive">active sources</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ event_timeline_data|last|default:0 }}</div>
        <div class="stat-label">Participation (last 30d)</div>
        <div class="stat-change negative">{% firstof drop_rate " " %}</div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Distribution by States</h3>
        </div>
        <div class="card-body">
          <canvas id="stateChart" class="chart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Distribution by Race</h3>
        </div>
        <div class="card-body">
          <canvas id="raceChart" class="chart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Distribution by Gender</h3>
        </div>
        <div class="card-body">
          <canvas id="genderChart" class="chart-small"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Distribution by Event Source</h3>
        </div>
        <div class="card-body">
          <canvas id="eventSourceChart" class="chart-small"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Registration Timeline (12 months)</h3>
        </div>
        <div class="card-body">
          <canvas id="registrationTimelineChart" class="chart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Event Participation Timeline</h3>
        </div>
        <div class="card-body">
          <canvas id="eventTimelineChart" class="chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Cross-tabulation Table -->
    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">State × Race Cross-tabulation</h3>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>State</th>
            {% for race in cross_tab_races %}<th>{{ race }}</th>{% endfor %}
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for state, races in cross_tabulation.items %}
          <tr>
            <td>{{ state }}</td>
            {% for race in cross_tab_races %}<td>{{ races|lookup:race|default:0 }}</td>{% endfor %}
            <td><strong>{{ races.total|default:0 }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Recent Contacts Table -->
    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Recent Contacts</h3>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>State</th>
            <th>Race</th>
            <th>Event Source</th>
            <th>Date Added</th>
          </tr>
        </thead>
        <tbody>
          {% for contact in recent_contacts %}
          <tr>
            <td>{{ contact.name }}</td>
            <td>{{ contact.phone_number }}</td>
            <td><span class="badge">{{ contact.get_state_display|default:"-" }}</span></td>
            <td><span class="badge">{{ contact.get_race_display|default:"-" }}</span></td>
            <td>{{ contact.event_source|default:"-" }}</td>
            <td>{{ contact.date_added|date:"M d, Y" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" style="text-align:center; color:var(--fb-gray-dark); padding:40px;">
              No contacts found
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

    <!-- Chart.js Initialization Scripts -->
    <script>
        // Chart color palette - More distinct and varied colors
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', 
            '#54A0FF', '#5F27CD', '#00D2D3', '#FF9F43', '#EE5A24', '#0ABDE3',
            '#10AC84', '#F79F1F', '#A3CB38', '#FDA7DF', '#6C5CE7', '#26DE81',
            '#FD79A8', '#FDCB6E', '#6C5CE7', '#A29BFE', '#74B9FF', '#00CEC9',
            '#55A3FF', '#FD79A8', '#FDCB6E', '#81ECEC', '#FFB8B8', '#C4E538'
        ];

        // State Distribution Chart
        const stateCtx = document.getElementById('stateChart').getContext('2d');
        new Chart(stateCtx, {
            type: 'doughnut',
            data: {
                labels: {{ state_labels|safe }},
                datasets: [{
                    data: {{ state_data|safe }},
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    }
                }
            }
        });

        // Race Distribution Chart
        const raceCtx = document.getElementById('raceChart').getContext('2d');
        new Chart(raceCtx, {
            type: 'pie',
            data: {
                labels: {{ race_labels|safe }},
                datasets: [{
                    data: {{ race_data|safe }},
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    }
                }
            }
        });

        // Gender Distribution Chart
        const genderCtx = document.getElementById('genderChart').getContext('2d');
        new Chart(genderCtx, {
            type: 'bar',
            data: {
                labels: {{ gender_labels|safe }},
                datasets: [{
                    label: 'Number of Contacts',
                    data: {{ gender_data|safe }},
                    backgroundColor: ['#36A2EB', '#FF6384'],
                    borderColor: ['#2E8BC0', '#E55A71'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Event Source Distribution Chart
        const eventSourceCtx = document.getElementById('eventSourceChart').getContext('2d');
        new Chart(eventSourceCtx, {
            type: 'bar',
            data: {
                labels: {{ event_source_labels|safe }},
                datasets: [{
                    label: 'Number of Participants',
                    data: {{ event_source_data|safe }},
                    backgroundColor: colors.slice(0, {{ event_source_labels|length }}),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Registration Timeline Chart
        const registrationTimelineCtx = document.getElementById('registrationTimelineChart').getContext('2d');
        new Chart(registrationTimelineCtx, {
            type: 'line',
            data: {
                labels: {{ timeline_labels|safe }},
                datasets: [{
                    label: 'New Registrations',
                    data: {{ timeline_data|safe }},
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Event Timeline Chart
        const eventTimelineCtx = document.getElementById('eventTimelineChart').getContext('2d');
        new Chart(eventTimelineCtx, {
            type: 'line',
            data: {
                labels: {{ event_timeline_labels|safe }},
                datasets: [{
                    label: 'Event Participants',
                    data: {{ event_timeline_data|safe }},
                    borderColor: '#FF6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    </script>

        </div> <!-- Close main-content -->
    </div> <!-- Close layout -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-font-awesome-kit.js" crossorigin="anonymous"></script>



</body>
</html>
