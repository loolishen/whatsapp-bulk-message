<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Customers - WhatsApp Bulk Message</title>

  <style>
    /* ===== Modern CRM theme (shared) ===== */
    :root{
      --bg:#f3f6fb; --card:#fff; --text:#0f172a; --muted:#667085; --line:#e5e7eb;
      --brand:#0ea5e9; --brand-strong:#0284c7; --accent:#22c55e; --radius:14px;
      --shadow:0 6px 20px rgba(2,8,23,.08);
      --danger:#ef4444; --danger-600:#dc2626;
      --soft:#f8fafc; --chip:#f1f5f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* ===== Topbar with centered tabs (same as recipients/CRM) ===== */
    .topbar { position: sticky; top: 0; z-index: 1000; background:#ffffff; border-bottom:1px solid #e5e7eb; }
    .topbar__inner { max-width:1280px; margin:0 auto; display:grid; grid-template-columns:280px 1fr 280px; align-items:center; gap:12px; padding:10px 16px; }
    .brand { display:flex; align-items:center; gap:10px; text-decoration:none; }
    .brand__logo { width:36px; height:36px; border-radius:8px; display:grid; place-items:center; background:#0ea5e9; color:#fff; font-weight:800; font-size:18px; }
    .brand__text { color:#0f172a; font-weight:800; letter-spacing:.2px }

    .tabs { display:flex; justify-content:center; gap:6px; }
    .tab { min-width:110px; height:40px; display:grid; place-items:center; border-radius:10px; color:#64748b; text-decoration:none; font-weight:700; padding:0 10px; }
    .tab:hover { background:#f1f5f9; color:#0f172a; }
    .tab--active { color:#0ea5e9; }
    .tab__icon { display:flex; align-items:center; gap:8px; font-size:14px }

    .actions { display:flex; justify-content:flex-end; gap:8px; align-items:center; }
    .action { width:40px; height:40px; border-radius:999px; display:grid; place-items:center; background:#f1f5f9; border:1px solid #e5e7eb; }
    .action:hover { background:#e2e8f0 }
    .avatar { width:36px; height:36px; border-radius:999px; background:#0ea5e9; color:#fff; display:grid; place-items:center; font-weight:800 }

    /* ===== Single-column layout (no sidebar) ===== */
    .layout{max-width:1280px;margin:22px auto;display:block;padding:0 20px}
    .page{display:grid;gap:20px;grid-template-columns:1fr;grid-template-areas:
      "title" "stats" "add" "import" "table";}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:16px}
    .page-title.card{grid-area:title;padding:18px}
    .page-title h1{margin:0;font-size:20px}

    /* Stats tiles */
    .stats.card{grid-area:stats;padding:14px 16px}
    .stats-wrap{display:flex;gap:16px;flex-wrap:wrap}
    .stat{flex:1 1 220px;background:var(--soft);border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center}
    .stat-number{font-size:26px;font-weight:800;color:var(--brand-strong)}
    .stat-label{font-size:13px;color:var(--muted)}

    /* Forms */
    .add-form.card{grid-area:add;padding:18px}
    .import-form.card{grid-area:import;padding:18px;border-left:4px solid var(--brand)}
    label{display:block;font-size:12px;color:#475569;font-weight:700;margin:8px 0 6px}
    input[type="text"],input[type="file"],textarea, select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px;outline:none;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(14,165,233,.25)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid transparent;font-weight:700;cursor:pointer;transition:.15s}
    .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{background:var(--brand-strong)}
    .btn-secondary{background:#eef6ff;color:#0b5cab;border:1px solid #dbeafe}
    .btn-secondary:hover{background:#e3f0ff}
    .btn-danger{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca}
    .btn-danger:hover{background:#fecaca}
    .btn-warning{background:#fff7ed;color:#c2410c;border:1px solid #fed7aa}
    .btn-warning:hover{background:#ffedd5}

    /* Drag & drop input display */
    .file-display{ padding:12px;border:2px dashed var(--brand);border-radius:12px;background:#fff;text-align:center;transition:.15s;cursor:pointer }
    .file-display:hover{background:#f8fbff;border-color:#7ccdf1}
    .file-info{margin-top:10px;background:#fff;border-left:4px solid #22c55e;border:1px solid var(--line);border-radius:8px;padding:10px;display:none}

    /* Import progress/results */
    .import-progress{margin-top:15px;display:none}
    .progress-bar{width:100%;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#4caf50,#45a049);width:0%;transition:width .3s ease}
    .import-results{margin-top:12px;padding:14px;border-radius:10px;display:none}
    .import-results.success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
    .import-results.error{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
    .import-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px}
    .summary-item{background:#fff;border:1px solid var(--line);border-radius:10px;text-align:center;padding:10px}
    .summary-number{font-size:20px;font-weight:800;color:var(--brand-strong)}
    .summary-label{font-size:12px;color:var(--muted)}

    /* Table */
    .table.card{grid-area:table;overflow:hidden}
    .table-toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .search{max-width:320px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:var(--soft);text-align:left;padding:12px 14px;font-size:12px;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--line)}
    td{padding:12px 14px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#f9fbff}
    .actions{white-space:nowrap}

    /* Inline edit row */
    .edit-row{display:none;background:#f7fff9}
    .edit-row input, .edit-row select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px}

    /* Responsive tweaks for sections */
    @media (max-width:700px){
      .topbar__inner{grid-template-columns:1fr; gap:8px}
      .actions{justify-content:center}
    }
  </style>
</head>
<body>

  <!-- ===== TOPBAR ===== -->
  <nav class="topbar">
    <div class="topbar__inner">
      <!-- Left: Brand -->
      <a href="{% url 'main_page' %}" class="brand">
        <div class="brand__logo">WA</div>
        <div class="brand__text">Campaign</div>
      </a>

      <!-- Center: Tabs -->
      <div class="tabs">
        <a href="{% url 'main_page' %}" class="tab {% if request.path == '/' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12l9-9 9 9" /><path d="M9 21V9h6v12" />
            </svg>
            Campaign
          </span>
        </a>
        <a href="{% url 'manage_customers' %}" class="tab {% if request.path|slice:':10' == '/customers' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 11a4 4 0 1 0-8 0" />
              <path d="M3 21a7 7 0 0 1 18 0" />
            </svg>
            Customers
          </span>
        </a>
        <a href="{% url 'crm_dashboard' %}" class="tab {% if request.resolver_match.url_name == 'crm_dashboard' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
            </svg>
            CRM
          </span>
        </a>
        <a href="{% url 'analytics_dashboard' %}" class="tab {% if request.resolver_match.url_name == 'analytics_dashboard' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="4" y1="21" x2="4" y2="14"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
              <line x1="15" y1="21" x2="15" y2="4"></line>
              <line x1="20" y1="21" x2="20" y2="17"></line>
            </svg>
            Analytics
          </span>
        </a>
      </div>

      <!-- Right: Actions -->
      <div class="actions">
        <button class="action" title="Add Customer" onclick="document.getElementById('name').focus()" aria-label="Add Customer">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <div class="avatar" title="You">{{ request.user.first_name|default:"U"|slice:":1"|upper }}</div>
      </div>
    </div>
  </nav>

  <div class="layout">
    <main class="page">
      <!-- Title -->
      <section class="page-title card">
        <h1>Customer Management</h1>
      </section>

      <!-- Stats -->
      <section class="stats card">
        <div class="stats-wrap">
          <div class="stat">
            <div class="stat-number">{{ contacts.count }}</div>
            <div class="stat-label">Total Customers</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="selectedCount">0</div>
            <div class="stat-label">Selected</div>
          </div>
        </div>
      </section>

      <!-- Add Customer -->
      <section class="add-form card">
        <h2>Add New Customer</h2>
        <form method="post" action="{% url 'add_contact' %}">
          {% csrf_token %}
          <input type="hidden" name="redirect_to" value="customers">

          <label for="name">Customer Name</label>
          <input type="text" id="name" name="name" placeholder="Enter customer name" required>

          <label for="phone">Phone Number</label>
          <input type="text" id="phone" name="phone" placeholder="+1234567890" required>

          <label for="state">State</label>
          <select id="state" name="state">
            {% for value, display in state_choices %}
              <option value="{{ value }}">{{ display }}</option>
            {% endfor %}
          </select>

          <label for="gender">Gender</label>
          <select id="gender" name="gender">
            {% for value, display in gender_choices %}
              <option value="{{ value }}">{{ display }}</option>
            {% endfor %}
          </select>

          <label for="race">Race</label>
          <select id="race" name="race">
            {% for value, display in race_choices %}
              <option value="{{ value }}">{{ display }}</option>
            {% endfor %}
          </select>

          <label for="event_source">Event Source</label>
          <input type="text" id="event_source" name="event_source" placeholder="e.g., Annual Dinner 2025, Marketing Campaign">

          <label for="date_added">Date Added (Optional)</label>
          <input type="date" id="date_added" name="date_added">

          <div style="margin-top:10px">
            <button type="submit" class="btn btn-primary">Add Customer</button>
          </div>
        </form>
      </section>

      <!-- Import Customers -->
      <section class="import-form card">
        <h2>📁 Import Customers from Excel</h2>
        <p class="muted" style="margin-bottom:14px">
          Upload an Excel file (.xlsx, .xls). We’ll scan all sheets, remove duplicates, and add valid rows.
        </p>

        <form id="importForm" enctype="multipart/form-data">
          {% csrf_token %}
          <label for="excelFile">Select Excel File</label>
          <input type="file" id="excelFile" name="excel_file" accept=".xlsx,.xls" style="display:none" required>
          <div class="file-display" onclick="document.getElementById('excelFile').click()">
            <div style="font-size:24px">📄</div>
            <div id="fileDisplayText">Click to select Excel file or drag & drop</div>
          </div>
          <div class="file-info" id="fileInfo"></div>

          <label style="margin-top:14px">Expected Excel Format</label>
          <div style="background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:monospace;font-size:12px">
            <strong>Column B:</strong> Customer Name<br>
            <strong>Column C:</strong> Phone Number<br>
            <em class="muted">Headers in the first row are optional</em>
          </div>

          <div style="margin-top:12px">
            <button type="button" onclick="importExcelFile()" class="btn btn-secondary" id="importBtn">📥 Import Customers</button>
          </div>
        </form>

        <div class="import-progress" id="importProgress">
          <p>Processing Excel file...</p>
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>

        <div class="import-results" id="importResults">
          <div id="resultsContent"></div>
          <div class="import-summary" id="importSummary"></div>
        </div>
      </section>

      <!-- Table -->
      <section class="table card">
        <div class="table-toolbar">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <label for="customerFilter" class="muted" style="font-weight:700">Search</label>
            <input type="text" id="customerFilter" class="search" placeholder="Search name or phone…">

            <!-- Filter dropdowns -->
            <form method="get" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap" id="filterForm">
              <label for="stateFilter" class="muted" style="font-weight:700">State:</label>
              <select id="stateFilter" name="state" onchange="document.getElementById('filterForm').submit()" style="padding:6px 10px;border:1px solid var(--line);border-radius:8px;font-size:13px;">
                <option value="">All States</option>
                {% for value, display in state_choices %}
                  <option value="{{ value }}" {% if value == selected_state %}selected{% endif %}>{{ display }}</option>
                {% endfor %}
              </select>

              <label for="genderFilter" class="muted" style="font-weight:700">Gender:</label>
              <select id="genderFilter" name="gender" onchange="document.getElementById('filterForm').submit()" style="padding:6px 10px;border:1px solid var(--line);border-radius:8px;font-size:13px;">
                <option value="">All Genders</option>
                {% for value, display in gender_choices %}
                  <option value="{{ value }}" {% if value == selected_gender %}selected{% endif %}>{{ display }}</option>
                {% endfor %}
              </select>

              <label for="raceFilter" class="muted" style="font-weight:700">Race:</label>
              <select id="raceFilter" name="race" onchange="document.getElementById('filterForm').submit()" style="padding:6px 10px;border:1px solid var(--line);border-radius:8px;font-size:13px;">
                <option value="">All Races</option>
                {% for value, display in race_choices %}
                  <option value="{{ value }}" {% if value == selected_race %}selected{% endif %}>{{ display }}</option>
                {% endfor %}
              </select>

              {% if selected_state or selected_gender or selected_race %}
                <a href="{% url 'manage_customers' %}" class="btn btn-secondary" style="font-size:12px;padding:6px 10px;">Clear Filters</a>
              {% endif %}
            </form>
          </div>
          <div>
            <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
            <button class="btn btn-danger" onclick="deleteSelected()" id="deleteSelectedBtn" style="display:none">Delete Selected</button>
          </div>
        </div>

        <table id="customersTable">
          <thead>
            <tr>
              <th style="width:44px"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
              <th>Name</th>
              <th>Phone Number</th>
              <th>State</th>
              <th>Gender</th>
              <th>Race</th>
              <th>Event Source</th>
              <th>Events Count</th>
              <th>Date Added</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for contact in contacts %}
            <tr id="row{{ contact.id }}">
              <td><input type="checkbox" class="contact-checkbox" value="{{ contact.id }}" onchange="updateSelection()"></td>
              <td id="name{{ contact.id }}">{{ contact.name }}</td>
              <td id="phone{{ contact.id }}">{{ contact.phone_number }}</td>
              <td id="state{{ contact.id }}">{{ contact.get_state_display }}</td>
              <td id="gender{{ contact.id }}">{{ contact.get_gender_display }}</td>
              <td id="race{{ contact.id }}">{{ contact.get_race_display }}</td>
              <td id="eventSource{{ contact.id }}">{{ contact.event_source|default:"N/A" }}</td>
              <td id="eventsCount{{ contact.id }}" style="text-align: center;">
                {% if contact.events_count > 1 %}
                  <span style="background:#e3f2fd;color:#1976d2;padding:2px 6px;border-radius:12px;font-size:11px;font-weight:600;">{{ contact.events_count }} events</span>
                {% else %}
                  {{ contact.events_count }}
                {% endif %}
              </td>
              <td id="dateAdded{{ contact.id }}">{% if contact.date_added %}{{ contact.date_added|date:"M d, Y" }}{% else %}N/A{% endif %}</td>
              <td>{{ contact.created_at|date:"M d, Y" }}</td>
              <td class="actions">
                <button class="btn btn-warning" onclick="editContact('{{ contact.id }}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteContact('{{ contact.id }}')">Delete</button>
              </td>
            </tr>
            <tr id="editRow{{ contact.id }}" class="edit-row">
              <td></td>
              <td><input type="text" id="editName{{ contact.id }}" value="{{ contact.name }}"></td>
              <td><input type="text" id="editPhone{{ contact.id }}" value="{{ contact.phone_number }}"></td>
              <td>
                <select id="editState{{ contact.id }}">
                  {% for value, display in state_choices %}
                    <option value="{{ value }}" {% if value == contact.state %}selected{% endif %}>{{ display }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select id="editGender{{ contact.id }}">
                  {% for value, display in gender_choices %}
                    <option value="{{ value }}" {% if value == contact.gender %}selected{% endif %}>{{ display }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select id="editRace{{ contact.id }}">
                  {% for value, display in race_choices %}
                    <option value="{{ value }}" {% if value == contact.race %}selected{% endif %}>{{ display }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input type="text" id="editEventSource{{ contact.id }}" value="{{ contact.event_source }}" placeholder="Event source"></td>
              <td style="text-align:center;color:var(--muted);font-size:12px;">{{ contact.events_count }} event{{ contact.events_count|pluralize }}</td>
              <td><input type="date" id="editDateAdded{{ contact.id }}" value="{% if contact.date_added %}{{ contact.date_added|date:'Y-m-d' }}{% endif %}"></td>
              <td>{{ contact.created_at|date:"M d, Y" }}</td>
              <td class="actions">
                <button class="btn btn-primary" onclick="saveContact('{{ contact.id }}')">Save</button>
                <button class="btn btn-secondary" onclick="cancelEdit('{{ contact.id }}')">Cancel</button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="11" style="text-align:center;color:var(--muted);padding:30px">No customers found. Add your first customer above.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    /* ===== Client-side search ===== */
    document.getElementById('customerFilter').addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      document.querySelectorAll('#customersTable tbody tr').forEach(tr=>{
        if (tr.classList.contains('edit-row')) return;
        const name = (tr.querySelector('[id^="name"]')?.innerText || '').toLowerCase();
        const phone = (tr.querySelector('[id^="phone"]')?.innerText || '').toLowerCase();
        tr.style.display = (name + ' ' + phone).includes(q) ? '' : 'none';
      });
    });

    /* ===== Selection & bulk actions ===== */
    let selectedContacts = new Set();

    function updateSelection() {
      selectedContacts.clear();
      document.querySelectorAll('.contact-checkbox:checked').forEach(cb => selectedContacts.add(parseInt(cb.value)));
      document.getElementById('selectedCount').textContent = selectedContacts.size;
      document.getElementById('deleteSelectedBtn').style.display = selectedContacts.size > 0 ? 'inline-flex' : 'none';

      const total = document.querySelectorAll('.contact-checkbox').length;
      const master = document.getElementById('selectAllCheckbox');
      master.checked = (selectedContacts.size === total && total > 0);
    }

    function toggleSelectAll() {
      const master = document.getElementById('selectAllCheckbox');
      document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = master.checked);
      updateSelection();
    }

    function selectAll() {
      document.getElementById('selectAllCheckbox').checked = true;
      toggleSelectAll();
    }

    /* ===== Inline edit ===== */
    function editContact(id){
      document.getElementById(`row${id}`).style.display='none';
      document.getElementById(`editRow${id}`).style.display='table-row';
    }
    function cancelEdit(id){
      document.getElementById(`row${id}`).style.display='table-row';
      document.getElementById(`editRow${id}`).style.display='none';
    }
    function saveContact(id){
      const name = document.getElementById(`editName${id}`).value.trim();
      const phone = document.getElementById(`editPhone${id}`).value.trim();
      const state = document.getElementById(`editState${id}`).value;
      const gender = document.getElementById(`editGender${id}`).value;
      const race = document.getElementById(`editRace${id}`).value;
      const eventSource = document.getElementById(`editEventSource${id}`).value.trim();
      const dateAdded = document.getElementById(`editDateAdded${id}`).value;

      if(!name || !phone){ alert('Please fill in name and phone fields'); return; }

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/edit-contact/${id}/`;
      const csrfToken = (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value;
      form.innerHTML = `
        <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
        <input type="hidden" name="name" value="${name}">
        <input type="hidden" name="phone" value="${phone}">
        <input type="hidden" name="state" value="${state}">
        <input type="hidden" name="gender" value="${gender}">
        <input type="hidden" name="race" value="${race}">
        <input type="hidden" name="event_source" value="${eventSource}">
        <input type="hidden" name="date_added" value="${dateAdded}">
      `;
      document.body.appendChild(form);
      form.submit();
    }

    /* ===== Delete single / bulk ===== */
    function deleteContact(id){
      if(confirm('Are you sure you want to delete this customer?')){
        window.location.href = `/delete-contact/${id}/`;
      }
    }

    function deleteSelected(){
      if (selectedContacts.size === 0){ alert('Please select at least one customer to delete.'); return; }
      if (!confirm(`Are you sure you want to delete ${selectedContacts.size} selected customer(s)?`)) return;

      const ids = Array.from(selectedContacts);
      let done = 0;
      const csrf = (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value;

      ids.forEach(id=>{
        fetch(`/delete-contact/${id}/`, { method:'POST', headers:{ 'X-CSRFToken': csrf } })
          .then(()=>{ done++; if(done===ids.length){ location.reload(); } })
          .catch(()=>{ done++; if(done===ids.length){ location.reload(); } });
      });
    }

    // Init
    updateSelection();

    /* ===== Excel import (with progress + results) ===== */
    let selectedFileForImport = null;

    document.getElementById('excelFile').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(file){
        document.getElementById('fileDisplayText').textContent = file.name;
        const fi = document.getElementById('fileInfo');
        fi.innerHTML = `<strong>📄 ${file.name}</strong><br>Size: ${(file.size/1024).toFixed(2)} KB<br>Type: ${file.type || 'Excel file'}`;
        fi.style.display = 'block';
        selectedFileForImport = file;
      }
    });

    function importExcelFile(){
      const file = selectedFileForImport || (document.getElementById('excelFile').files[0]);
      if(!file){ alert('Please select an Excel file first.'); return; }

      const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel','application/excel','application/x-excel','application/x-msexcel'
      ];
      if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)){
        alert('Please select a valid Excel file (.xlsx or .xls).'); return;
      }

      // Show lightweight inline progress & send
      performExcelImport(file);
    }

    function performExcelImport(file) {
      const importProgress = document.getElementById('importProgress');
      const importResults  = document.getElementById('importResults');
      const importBtn      = document.getElementById('importBtn');
      importProgress.style.display='block'; importResults.style.display='none';
      importBtn.disabled=true; importBtn.textContent='Processing...';

      let progress=0; const fill=document.getElementById('progressFill');
      const itv = setInterval(()=>{ progress+=Math.random()*10; if(progress>90) progress=90; fill.style.width = progress+'%'; }, 100);

      const fd = new FormData();
      fd.append('excel_file', file, file.name);
      fd.append('csrfmiddlewaretoken', (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value);

      // Optional helpers – backend can ignore if not used
      fd.append('has_header', '0');
      fd.append('name_col',  '0');
      fd.append('phone_col', '1');

      const csrfHeader = (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value;

      fetch('/import-excel/', {
        method: 'POST',
        body: fd,
        headers: { 'X-CSRFToken': csrfHeader }
      })
      .then(r=>r.json())
      .then(data=>{
        clearInterval(itv); fill.style.width='100%';
        setTimeout(()=>{
          importProgress.style.display='none';
          importBtn.disabled=false; importBtn.textContent='📥 Import Customers';

          const resultsDiv     = document.getElementById('importResults');
          const resultsContent = document.getElementById('resultsContent');
          const importSummary  = document.getElementById('importSummary');

          if(data.success){
            resultsDiv.className='import-results success';
            resultsContent.innerHTML = `<strong>✅ Import Successful!</strong><br>${data.message || ''}`;
            const s = data.summary || {};
            importSummary.innerHTML = `
              <div class="summary-item"><div class="summary-number">${s.total_processed ?? 0}</div><div class="summary-label">Rows Processed</div></div>
              <div class="summary-item"><div class="summary-number">${s.added ?? 0}</div><div class="summary-label">New Customers</div></div>
              <div class="summary-item"><div class="summary-number">${s.duplicates ?? 0}</div><div class="summary-label">Duplicates Removed</div></div>
              <div class="summary-item"><div class="summary-number">${s.errors ?? 0}</div><div class="summary-label">Errors</div></div>
              <div class="summary-item"><div class="summary-number">${s.sheets_processed ?? 0}</div><div class="summary-label">Sheets Scanned</div></div>
            `;
            setTimeout(()=>location.reload(), 3000);
          } else {
            resultsDiv.className='import-results error';
            resultsContent.innerHTML = `<strong>❌ Import Failed</strong><br>${data.message || 'Unknown error.'}`;
            importSummary.innerHTML='';
          }
          resultsDiv.style.display='block';

          // Reset input UI
          document.getElementById('excelFile').value='';
          selectedFileForImport = null;
          const fi = document.getElementById('fileInfo'); if (fi) fi.style.display='none';
          const fdt = document.getElementById('fileDisplayText'); if (fdt) fdt.textContent='Click to select Excel file or drag & drop';
        }, 400);
      })
      .catch(err=>{
        clearInterval(itv);
        console.error(err);
        importProgress.style.display='none';
        importBtn.disabled=false; importBtn.textContent='📥 Import Customers';
        const resultsDiv=document.getElementById('importResults');
        resultsDiv.className='import-results error';
        document.getElementById('resultsContent').innerHTML = `<strong>❌ Import Error</strong><br>An error occurred while importing the file. Please try again.`;
        document.getElementById('importSummary').innerHTML='';
        resultsDiv.style.display='block';
      });
    }
  </script>
</body>
</html>
```

If you want the **Customers** tab to highlight via a different Django check (e.g., `request.resolver_match.url_name == 'manage_customers'`), swap that into the tab class logic.
