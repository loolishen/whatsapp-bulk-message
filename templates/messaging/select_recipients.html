<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select Recipients - WhatsApp Bulk Message</title>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <style>
    /* ===== Facebook CRM Design System ===== */
    :root{
      --fb-blue:#1877f2; --fb-blue-hover:#166fe5; --fb-blue-light:#e7f3ff;
      --fb-gray:#f0f2f5; --fb-gray-dark:#65676b; --fb-gray-light:#f8f9fa;
      --fb-white:#ffffff; --fb-black:#1c1e21; --fb-text:#1c1e21;
      --fb-success:#42b883; --fb-warning:#f7b731; --fb-danger:#e74c3c;
      --fb-border:#dadde1; --fb-shadow:0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);
      --fb-radius:8px; --fb-radius-lg:12px;
    }
    *{box-sizing:border-box; margin:0; padding:0}
    body{background:var(--fb-gray); color:var(--fb-text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; line-height:1.4}

    /* ===== Facebook-style Top Navigation ===== */
    .topbar{
      background:var(--fb-white); border-bottom:1px solid var(--fb-border);
      position:sticky; top:0; z-index:1000; box-shadow:0 1px 2px rgba(0,0,0,0.1)
    }
    .topbar__inner{
      max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between;
      padding:8px 16px; height:56px
    }
    .brand{
      display:flex; align-items:center; gap:8px; text-decoration:none; font-weight:700; font-size:20px
    }
    .brand__logo{
      width:40px; height:40px; border-radius:50%; background:var(--fb-blue);
      display:flex; align-items:center; justify-content:center; color:white; font-weight:800
    }
    .brand__text{color:var(--fb-text)}

    .nav-tabs{
      display:flex; gap:8px; align-items:center; flex:1; justify-content:center
    }
    .nav-tab{
      padding:8px 16px; border-radius:var(--fb-radius); text-decoration:none; font-weight:600;
      color:var(--fb-gray-dark); transition:all 0.2s; position:relative
    }
    .nav-tab:hover{background:var(--fb-gray-light); color:var(--fb-text)}
    .nav-tab.active{color:var(--fb-blue); background:var(--fb-blue-light)}
    .nav-tab.active::after{
      content:''; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%);
      width:100%; height:3px; background:var(--fb-blue); border-radius:2px
    }

    .topbar-actions{
      display:flex; gap:8px; align-items:center
    }
    .action-btn{
      width:40px; height:40px; border-radius:50%; background:var(--fb-gray-light);
      border:none; display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:background 0.2s; color:var(--fb-gray-dark)
    }
    .action-btn:hover{background:var(--fb-border)}
    .user-avatar{
      width:32px; height:32px; border-radius:50%; background:var(--fb-blue);
      display:flex; align-items:center; justify-content:center; color:white;
      font-weight:600; font-size:14px
    }

    /* ===== Main Layout ===== */
    .main-container{max-width:1200px; margin:0 auto; padding:20px 16px}
    .page-header{margin-bottom:24px}
    .page-title{font-size:28px; font-weight:700; color:var(--fb-text); margin-bottom:8px}
    .page-subtitle{color:var(--fb-gray-dark); font-size:16px}

    /* ===== Facebook-style Cards ===== */
    .card{
      background:var(--fb-white); border-radius:var(--fb-radius-lg); box-shadow:var(--fb-shadow);
      border:1px solid var(--fb-border); margin-bottom:16px
    }
    .card-header{
      padding:16px 20px; border-bottom:1px solid var(--fb-border);
      display:flex; align-items:center; justify-content:space-between
    }
    .card-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .card-body{padding:20px}

    /* ===== Forms ===== */
    .form-group{margin-bottom:16px}
    .form-label{
      display:block; font-size:14px; font-weight:600; color:var(--fb-text);
      margin-bottom:6px
    }
    .form-input, .form-select{
      width:100%; padding:12px 16px; border:1px solid var(--fb-border); border-radius:var(--fb-radius);
      background:var(--fb-white); font-size:14px; transition:border-color 0.2s
    }
    .form-input:focus, .form-select:focus{
      outline:none; border-color:var(--fb-blue); box-shadow:0 0 0 3px rgba(24,119,242,0.1)
    }

    /* ===== Buttons ===== */
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 20px;
      border-radius:var(--fb-radius); font-weight:600; cursor:pointer;
      transition:all 0.2s; text-decoration:none; border:none; font-size:14px
    }
    .btn-primary{background:var(--fb-blue); color:white}
    .btn-primary:hover{background:var(--fb-blue-hover)}
    .btn-secondary{background:var(--fb-gray-light); color:var(--fb-text); border:1px solid var(--fb-border)}
    .btn-secondary:hover{background:var(--fb-border)}

    /* ===== Table ===== */
    .table-container{background:var(--fb-white); border-radius:var(--fb-radius-lg); overflow:hidden; box-shadow:var(--fb-shadow)}
    .table-header{
      padding:16px 20px; border-bottom:1px solid var(--fb-border);
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px
    }
    .table-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .table-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .data-table{
      width:100%; border-collapse:collapse; font-size:14px
    }
    .data-table th{
      background:var(--fb-gray-light); padding:12px 16px; text-align:left;
      font-weight:600; color:var(--fb-text); border-bottom:1px solid var(--fb-border)
    }
    .data-table td{
      padding:12px 16px; border-bottom:1px solid var(--fb-border); vertical-align:middle
    }
    .data-table tbody tr:hover{background:var(--fb-gray-light)}

    .badge{
      display:inline-block; padding:4px 8px; border-radius:12px;
      font-size:12px; font-weight:600; background:var(--fb-gray-light); color:var(--fb-text)
    }

    /* ===== Responsive Design ===== */
    @media (max-width:768px){
      .topbar__inner{flex-direction:column; height:auto; padding:12px 16px; gap:12px}
      .nav-tabs{order:2; width:100%; justify-content:center; flex-wrap:wrap}
      .topbar-actions{order:3}
      .main-container{padding:16px 12px}
      .page-title{font-size:24px}
      .table-header{flex-direction:column; align-items:stretch}
      .table-actions{justify-content:center}
    }
    /* Message preview chip */
    .preview-chip{background:#f8fafc;border:1px solid var(--fb-border);border-radius:var(--fb-radius);padding:10px;font-size:14px;color:var(--fb-text)}
    .right{text-align:right}
    .select-btn{background:var(--fb-blue-light);color:var(--fb-blue);border:1px solid var(--fb-blue);border-radius:var(--fb-radius);padding:8px 12px;cursor:pointer;font-weight:700}
    .select-btn.selected{background:var(--fb-blue);color:white;border-color:var(--fb-blue)}
    .toolbar{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:12px 14px}
    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(243,246,251,0),rgba(243,246,251,1) 40%);padding:14px;border-top:1px solid var(--fb-border);display:flex;justify-content:flex-end;gap:10px}
  </style>
</head>
<body>

  <!-- Top NAV (same icons & logic) -->
  <nav class="topbar">
    <div class="topbar__inner">
      <!-- Left: brand -->
      <a href="{% url 'main_page' %}" class="brand">
        <div class="brand__logo">WA</div>
        <div class="brand__text">Campaign</div>
      </a>

      <!-- Center: tabs -->
      <div class="tabs">
        <a href="{% url 'main_page' %}" class="tab {% if request.path == '/' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12l9-9 9 9" /><path d="M9 21V9h6v12" />
            </svg>
            Campaign
          </span>
        </a>
        <a href="{% url 'manage_customers' %}" class="tab {% if request.path|slice:':10' == '/customers' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 11a4 4 0 1 0-8 0" />
              <path d="M3 21a7 7 0 0 1 18 0" />
            </svg>
            Customers
          </span>
        </a>
        <a href="{% url 'crm_home' %}" class="tab {% if request.resolver_match.url_name == 'crm_home' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
            </svg>
            CRM
          </span>
        </a>
        <a href="{% url 'analytics_dashboard' %}" class="tab {% if request.resolver_match.url_name == 'analytics_dashboard' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="4" y1="21" x2="4" y2="14"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
              <line x1="15" y1="21" x2="15" y2="4"></line>
              <line x1="20" y1="21" x2="20" y2="17"></line>
            </svg>
            Analytics
          </span>
        </a>
      </div>

      <!-- Right: actions -->
      <div class="actions">
        <button class="action" title="New Campaign" onclick="window.location.href='{% url 'main_page' %}#compose'" aria-label="New Campaign">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button class="action" title="Notifications" aria-label="Notifications">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 10-12 0v3.2c0 .53-.21 1.04-.59 1.41L4 17h5m6 0v1a3 3 0 11-6 0v-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <div class="avatar" title="You">{{ request.user.first_name|default:"U"|slice:":1"|upper }}</div>
      </div>
    </div>
  </nav>

  <div class="layout">
    <main class="stack">
      <!-- Add Contact (card) -->
      <section class="card" style="padding:18px">
        <h2>Add New Contact</h2>
        <form class="form-row" method="post" action="{% url 'add_contact' %}">
          {% csrf_token %}
          <div>
            <label>Contact Name</label>
            <input type="text" name="name" placeholder="Contact Name" required>
          </div>
          <div>
            <label>Phone Number</label>
            <input type="text" name="phone" placeholder="+1234567890" required>
          </div>
          <div>
            <button type="submit" class="btn btn-primary">Add Contact</button>
          </div>
        </form>
      </section>

      <!-- Select Recipients (card) -->
      <section class="card" style="overflow:hidden">
        <div class="toolbar">
          <div>
            <h2 style="display:inline-block;margin-right:10px">Select Recipients</h2>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-muted" onclick="goBack()">← Back to Message</button>
            <button class="btn btn-secondary" onclick="selectAll()" id="selectAllBtn">Select All</button>
            <button class="btn btn-primary" onclick="sendBulkMessage()" id="sendBtn">Send Message</button>
          </div>
        </div>

        <!-- Message preview chip (same vibe) -->
        <div class="preview-chip" id="messagePreview" style="display:none;margin:0 14px 12px">
          <strong style="color:#0f172a">Message Preview:</strong>
          <div id="previewText" style="margin-top:6px"></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone Number</th>
              <th class="right">Select</th>
            </tr>
          </thead>
          <tbody id="contactsList">
            {% for contact in contacts %}
            <tr>
              <td>{{ contact.name }}</td>
              <td>{{ contact.phone_number }}</td>
              <td class="right">
                <button class="select-btn" onclick="toggleSelect('{{ contact.id }}')" id="selectBtn{{ contact.id }}">Select</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="sticky-footer">
          <button class="btn btn-secondary" onclick="selectAll()" id="selectAllBtnFooter">Select All</button>
          <button class="btn btn-primary" onclick="sendBulkMessage()">Send</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* === Safer data & CSRF === */
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Build contacts array from server safely (no crashes if quotes present)
    const contacts = [
      {% for contact in contacts %}
        { id: {{ contact.id }}, name: {{ contact.name|escapejs|json_script:"n"|safe }}{{""}}, phone: {{ contact.phone_number|escapejs|json_script:"p"|safe }}{{""}} },
      {% endfor %}
    ].map((_,i)=>{ 
      // the inline json_script trick above prevents quote breaks; extract safely:
      const n = document.getElementById('n').textContent; 
      const p = document.getElementById('p').textContent; 
      // Remove helper nodes after first read
      if(i===0){ document.getElementById('n').remove(); document.getElementById('p').remove(); }
      return _;
    });

    // Fallback if you prefer: (simple & works if names/phones don't contain quotes)
    // const contacts = JSON.parse('{{ contacts_json|default:"[]"|escapejs }}');

    const selected = new Set();

    // Load message data (same as other page)
    const messageData = JSON.parse(localStorage.getItem('messageData') || '{}');
    if (messageData.message) {
      document.getElementById('messagePreview').style.display = 'block';
      document.getElementById('previewText').textContent = messageData.message;
    }

    function toggleSelect(contactId){
      const btn = document.getElementById(`selectBtn${contactId}`);
      if(selected.has(contactId)){ selected.delete(contactId); btn.classList.remove('selected'); btn.textContent='Select'; }
      else{ selected.add(contactId); btn.classList.add('selected'); btn.textContent='Selected'; }
      syncSelectAllButtons();
    }

    function selectAll(){
      if(selected.size === contacts.length && contacts.length>0){
        selected.clear();
        contacts.forEach(c=>{ const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.remove('selected'); b.textContent='Select'; } });
      }else{
        contacts.forEach(c=>{ selected.add(c.id); const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.add('selected'); b.textContent='Selected'; } });
      }
      syncSelectAllButtons();
    }

    function syncSelectAllButtons(){
      const top = document.getElementById('selectAllBtn');
      const foot = document.getElementById('selectAllBtnFooter');
      const label = (selected.size === contacts.length && contacts.length>0) ? 'Deselect All' : 'Select All';
      if(top) top.textContent = label;
      if(foot) foot.textContent = label;
    }

    function goBack(){ window.location.href = '{% url "main_page" %}'; }

    function sendBulkMessage(){
      if(selected.size===0){ alert('Please select at least one recipient.'); return; }
      if(!messageData.message){ alert('No message to send. Please go back and create a message.'); return; }

      fetch('/send-bulk/',{
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({
          message: messageData.message,
          time: messageData.time,
          image_url: messageData.imageUrl,
          recipients: Array.from(selected)
        })
      })
      .then(r=>r.json())
      .then(data=>{
        if(data.success){
          alert(data.message);
          localStorage.removeItem('messageData');
          window.location.href='{% url "main_page" %}';
        }else{
          alert('Failed to send message: ' + (data.message || 'Please try again.'));
        }
      })
      .catch(err=>{
        console.error(err);
        alert('An error occurred while sending the message.');
      });
    }
  </script>
</body>
</html>
