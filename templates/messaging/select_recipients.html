<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select Recipients - WhatsApp Bulk Message</title>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <style>
    /* ===== Modern CRM theme (same as recipients_and_preview.html) ===== */
    :root{
      --bg:#f3f6fb; --card:#fff; --text:#0f172a; --muted:#667085; --line:#e5e7eb;
      --brand:#0ea5e9; --brand-strong:#0284c7; --accent:#22c55e; --radius:14px;
      --shadow:0 6px 20px rgba(2,8,23,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Top bar (same pattern) */
    .topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid #e5e7eb}
    .topbar__inner{
      max-width:1100px;margin:0 auto;
      display:grid;grid-template-columns:220px 1fr 220px;
      align-items:center;gap:12px;padding:8px 16px;
    }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .brand__logo{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;background:var(--brand);color:#fff;font-weight:800;font-size:18px}
    .brand__text{color:var(--text);font-weight:800;letter-spacing:.2px}

    /* Tabs inline in top bar */
    .tabs{display:flex;justify-content:center;gap:6px}
    .tab{min-width:100px;height:40px;display:grid;place-items:center;border-radius:10px;color:#64748b;text-decoration:none;font-weight:700}
    .tab:hover{background:#f1f5f9;color:#0f172a}
    .tab--active{color:var(--brand)}
    .tab__icon{display:flex;align-items:center;gap:8px;font-size:14px}

    .actions{display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .action{width:40px;height:40px;border-radius:999px;display:grid;place-items:center;background:#f1f5f9;border:1px solid #e5e7eb}
    .action:hover{background:#e2e8f0}
    .avatar{width:36px;height:36px;border-radius:999px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:800}

    /* Page layout (single column) */
    .layout{max-width:1100px;margin:22px auto;display:grid;gap:20px;grid-template-columns:1fr;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0 0 12px;font-size:16px}

    /* Add contact + list */
    .stack{display:grid;gap:16px}
    .form-row{display:grid;gap:10px}
    label{display:block;font-size:12px;color:#475569;font-weight:700;margin:4px 0 4px}
    input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px;outline:none}
    input:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(14,165,233,.25)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid transparent;font-weight:700;cursor:pointer;transition:.15s}
    .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{background:var(--brand-strong)}
    .btn-secondary{background:#eef6ff;color:#0b5cab;border:1px solid #dbeafe}
    .btn-muted{background:#f1f5f9;color:#0f172a;border:1px solid var(--line)}

    /* Message preview chip */
    .preview-chip{background:#f8fafc;border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px;color:#0f172a}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#f8fafc;text-align:left;padding:12px 14px;font-size:12px;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--line)}
    td{padding:12px 14px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#f9fbff}
    .right{text-align:right}
    .select-btn{background:#eef6ff;color:#0b5cab;border:1px solid #dbeafe;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .select-btn.selected{background:var(--brand);color:#fff;border-color:var(--brand)}
    .toolbar{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:12px 14px}
    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(243,246,251,0),rgba(243,246,251,1) 40%);padding:14px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px}
  </style>
</head>
<body>

  <!-- Top NAV (same icons & logic) -->
  <nav class="topbar">
    <div class="topbar__inner">
      <!-- Left: brand -->
      <a href="{% url 'main_page' %}" class="brand">
        <div class="brand__logo">WA</div>
        <div class="brand__text">Campaign</div>
      </a>

      <!-- Center: tabs -->
      <div class="tabs">
        <a href="{% url 'main_page' %}" class="tab {% if request.path == '/' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12l9-9 9 9" /><path d="M9 21V9h6v12" />
            </svg>
            Campaign
          </span>
        </a>
        <a href="{% url 'manage_customers' %}" class="tab {% if request.path|slice:':10' == '/customers' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 11a4 4 0 1 0-8 0" />
              <path d="M3 21a7 7 0 0 1 18 0" />
            </svg>
            Customers
          </span>
        </a>
        <a href="{% url 'crm_dashboard' %}" class="tab {% if request.resolver_match.url_name == 'crm_dashboard' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
            </svg>
            CRM
          </span>
        </a>
        <a href="{% url 'analytics_dashboard' %}" class="tab {% if request.resolver_match.url_name == 'analytics_dashboard' %}tab--active{% endif %}">
          <span class="tab__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="4" y1="21" x2="4" y2="14"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
              <line x1="15" y1="21" x2="15" y2="4"></line>
              <line x1="20" y1="21" x2="20" y2="17"></line>
            </svg>
            Analytics
          </span>
        </a>
      </div>

      <!-- Right: actions -->
      <div class="actions">
        <button class="action" title="New Campaign" onclick="window.location.href='{% url 'main_page' %}#compose'" aria-label="New Campaign">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button class="action" title="Notifications" aria-label="Notifications">
          <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 10-12 0v3.2c0 .53-.21 1.04-.59 1.41L4 17h5m6 0v1a3 3 0 11-6 0v-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <div class="avatar" title="You">{{ request.user.first_name|default:"U"|slice:":1"|upper }}</div>
      </div>
    </div>
  </nav>

  <div class="layout">
    <main class="stack">
      <!-- Add Contact (card) -->
      <section class="card" style="padding:18px">
        <h2>Add New Contact</h2>
        <form class="form-row" method="post" action="{% url 'add_contact' %}">
          {% csrf_token %}
          <div>
            <label>Contact Name</label>
            <input type="text" name="name" placeholder="Contact Name" required>
          </div>
          <div>
            <label>Phone Number</label>
            <input type="text" name="phone" placeholder="+1234567890" required>
          </div>
          <div>
            <button type="submit" class="btn btn-primary">Add Contact</button>
          </div>
        </form>
      </section>

      <!-- Select Recipients (card) -->
      <section class="card" style="overflow:hidden">
        <div class="toolbar">
          <div>
            <h2 style="display:inline-block;margin-right:10px">Select Recipients</h2>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-muted" onclick="goBack()">‚Üê Back to Message</button>
            <button class="btn btn-secondary" onclick="selectAll()" id="selectAllBtn">Select All</button>
            <button class="btn btn-primary" onclick="sendBulkMessage()" id="sendBtn">Send Message</button>
          </div>
        </div>

        <!-- Message preview chip (same vibe) -->
        <div class="preview-chip" id="messagePreview" style="display:none;margin:0 14px 12px">
          <strong style="color:#0f172a">Message Preview:</strong>
          <div id="previewText" style="margin-top:6px"></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone Number</th>
              <th class="right">Select</th>
            </tr>
          </thead>
          <tbody id="contactsList">
            {% for contact in contacts %}
            <tr>
              <td>{{ contact.name }}</td>
              <td>{{ contact.phone_number }}</td>
              <td class="right">
                <button class="select-btn" onclick="toggleSelect('{{ contact.id }}')" id="selectBtn{{ contact.id }}">Select</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div class="sticky-footer">
          <button class="btn btn-secondary" onclick="selectAll()" id="selectAllBtnFooter">Select All</button>
          <button class="btn btn-primary" onclick="sendBulkMessage()">Send</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* === Safer data & CSRF === */
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Build contacts array from server safely (no crashes if quotes present)
    const contacts = [
      {% for contact in contacts %}
        { id: {{ contact.id }}, name: {{ contact.name|escapejs|json_script:"n"|safe }}{{""}}, phone: {{ contact.phone_number|escapejs|json_script:"p"|safe }}{{""}} },
      {% endfor %}
    ].map((_,i)=>{ 
      // the inline json_script trick above prevents quote breaks; extract safely:
      const n = document.getElementById('n').textContent; 
      const p = document.getElementById('p').textContent; 
      // Remove helper nodes after first read
      if(i===0){ document.getElementById('n').remove(); document.getElementById('p').remove(); }
      return _;
    });

    // Fallback if you prefer: (simple & works if names/phones don't contain quotes)
    // const contacts = JSON.parse('{{ contacts_json|default:"[]"|escapejs }}');

    const selected = new Set();

    // Load message data (same as other page)
    const messageData = JSON.parse(localStorage.getItem('messageData') || '{}');
    if (messageData.message) {
      document.getElementById('messagePreview').style.display = 'block';
      document.getElementById('previewText').textContent = messageData.message;
    }

    function toggleSelect(contactId){
      const btn = document.getElementById(`selectBtn${contactId}`);
      if(selected.has(contactId)){ selected.delete(contactId); btn.classList.remove('selected'); btn.textContent='Select'; }
      else{ selected.add(contactId); btn.classList.add('selected'); btn.textContent='Selected'; }
      syncSelectAllButtons();
    }

    function selectAll(){
      if(selected.size === contacts.length && contacts.length>0){
        selected.clear();
        contacts.forEach(c=>{ const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.remove('selected'); b.textContent='Select'; } });
      }else{
        contacts.forEach(c=>{ selected.add(c.id); const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.add('selected'); b.textContent='Selected'; } });
      }
      syncSelectAllButtons();
    }

    function syncSelectAllButtons(){
      const top = document.getElementById('selectAllBtn');
      const foot = document.getElementById('selectAllBtnFooter');
      const label = (selected.size === contacts.length && contacts.length>0) ? 'Deselect All' : 'Select All';
      if(top) top.textContent = label;
      if(foot) foot.textContent = label;
    }

    function goBack(){ window.location.href = '{% url "main_page" %}'; }

    function sendBulkMessage(){
      if(selected.size===0){ alert('Please select at least one recipient.'); return; }
      if(!messageData.message){ alert('No message to send. Please go back and create a message.'); return; }

      fetch('/send-bulk/',{
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({
          message: messageData.message,
          time: messageData.time,
          image_url: messageData.imageUrl,
          recipients: Array.from(selected)
        })
      })
      .then(r=>r.json())
      .then(data=>{
        if(data.success){
          alert(data.message);
          localStorage.removeItem('messageData');
          window.location.href='{% url "main_page" %}';
        }else{
          alert('Failed to send message: ' + (data.message || 'Please try again.'));
        }
      })
      .catch(err=>{
        console.error(err);
        alert('An error occurred while sending the message.');
      });
    }
  </script>
</body>
</html>
