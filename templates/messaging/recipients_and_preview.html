<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Bulk Message - Recipients & Preview</title>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <style>
    /* ===== Facebook CRM Design System ===== */
    :root{
      --fb-blue:#1877f2; --fb-blue-hover:#166fe5; --fb-blue-light:#e7f3ff;
      --fb-gray:#f0f2f5; --fb-gray-dark:#65676b; --fb-gray-light:#f8f9fa;
      --fb-white:#ffffff; --fb-black:#1c1e21; --fb-text:#1c1e21;
      --fb-success:#42b883; --fb-warning:#f7b731; --fb-danger:#e74c3c;
      --fb-border:#dadde1; --fb-shadow:0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1);
      --fb-radius:8px; --fb-radius-lg:12px;
    }
    *{box-sizing:border-box; margin:0; padding:0}
    body{background:var(--fb-gray); color:var(--fb-text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; line-height:1.4}

    /* ===== Facebook-style Top Navigation ===== */
    .topbar{
      background:var(--fb-white); border-bottom:1px solid var(--fb-border);
      position:sticky; top:0; z-index:1000; box-shadow:0 1px 2px rgba(0,0,0,0.1)
    }
    .topbar__inner{
      max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between;
      padding:8px 16px; height:56px
    }
    .brand{
      display:flex; align-items:center; gap:8px; text-decoration:none; font-weight:700; font-size:20px
    }
    .brand__logo{
      width:40px; height:40px; border-radius:50%; background:var(--fb-blue);
      display:flex; align-items:center; justify-content:center; color:white; font-weight:800
    }
    .brand__text{color:var(--fb-text)}

    .nav-tabs{
      display:flex; gap:8px; align-items:center; flex:1; justify-content:center
    }
    .nav-tab{
      padding:8px 16px; border-radius:var(--fb-radius); text-decoration:none; font-weight:600;
      color:var(--fb-gray-dark); transition:all 0.2s; position:relative
    }
    .nav-tab:hover{background:var(--fb-gray-light); color:var(--fb-text)}
    .nav-tab.active{color:var(--fb-blue); background:var(--fb-blue-light)}
    .nav-tab.active::after{
      content:''; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%);
      width:100%; height:3px; background:var(--fb-blue); border-radius:2px
    }

    .topbar-actions{
      display:flex; gap:8px; align-items:center
    }
    .action-btn{
      width:40px; height:40px; border-radius:50%; background:var(--fb-gray-light);
      border:none; display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:background 0.2s; color:var(--fb-gray-dark)
    }
    .action-btn:hover{background:var(--fb-border)}
    .user-avatar{
      width:32px; height:32px; border-radius:50%; background:var(--fb-blue);
      display:flex; align-items:center; justify-content:center; color:white;
      font-weight:600; font-size:14px
    }

    /* ===== Main Layout ===== */
    .main-container{max-width:1200px; margin:0 auto; padding:20px 16px}
    .page-header{margin-bottom:24px}
    .page-title{font-size:28px; font-weight:700; color:var(--fb-text); margin-bottom:8px}
    .page-subtitle{color:var(--fb-gray-dark); font-size:16px}

    /* ===== Facebook-style Cards ===== */
    .card{
      background:var(--fb-white); border-radius:var(--fb-radius-lg); box-shadow:var(--fb-shadow);
      border:1px solid var(--fb-border); margin-bottom:16px
    }
    .card-header{
      padding:16px 20px; border-bottom:1px solid var(--fb-border);
      display:flex; align-items:center; justify-content:space-between
    }
    .card-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .card-body{padding:20px}

    /* ===== Steps Wizard ===== */
    .wizard{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; padding:20px;
      background:var(--fb-white); border-radius:var(--fb-radius-lg); box-shadow:var(--fb-shadow);
      border:1px solid var(--fb-border); margin-bottom:20px; position:relative
    }
    .wizard::before{
      content:''; position:absolute; left:40px; right:40px; top:50px; height:2px;
      background:var(--fb-border); z-index:1
    }
    .wizard-step{
      background:transparent; border:none; text-align:left; display:flex; gap:12px;
      align-items:flex-start; cursor:pointer; padding:12px; border-radius:var(--fb-radius);
      transition:background 0.2s; position:relative; z-index:2
    }
    .wizard-step:hover{background:var(--fb-gray-light)}
    .wizard-badge{
      width:32px; height:32px; border-radius:50%; display:flex; align-items:center;
      justify-content:center; background:var(--fb-border); color:var(--fb-text);
      font-weight:700; border:2px solid var(--fb-white); flex:0 0 auto
    }
    .wizard-title{font-weight:600; font-size:14px; color:var(--fb-text)}
    .wizard-desc{font-size:12px; color:var(--fb-gray-dark); margin-top:4px}
    .wizard-step.complete .wizard-badge{background:var(--fb-success); color:white}
    .wizard-step.current .wizard-badge{background:var(--fb-blue); color:white; box-shadow:0 0 0 4px rgba(24,119,242,0.2)}
    .wizard-step.current .wizard-title{color:var(--fb-blue)}

    /* ===== Two Column Layout ===== */
    .content-grid{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px}
    .preview-section{background:var(--fb-white); border-radius:var(--fb-radius-lg); padding:20px; box-shadow:var(--fb-shadow); border:1px solid var(--fb-border)}
    .compose-section{background:var(--fb-white); border-radius:var(--fb-radius-lg); padding:20px; box-shadow:var(--fb-shadow); border:1px solid var(--fb-border)}

    /* ===== WhatsApp Preview ===== */
    .wa-phone{
      background:var(--fb-blue); border:8px solid #1f2937; border-radius:22px;
      overflow:hidden; width:360px; max-width:100%; margin:auto;
      box-shadow:0 18px 34px rgba(2,8,23,.18)
    }
    .wa-chat-header{
      background:#075e54; color:white; padding:12px 16px;
      display:flex; align-items:center; gap:12px
    }
    .wa-chat-avatar{
      width:36px; height:36px; border-radius:50%; background:#25d366;
      display:flex; align-items:center; justify-content:center; font-weight:800; font-size:16px
    }
    .wa-chat-info{flex:1}
    .wa-chat-name{font-weight:700; font-size:16px}
    .wa-chat-status{font-size:12px; color:#a5f3fc; margin-top:2px}
    .wa-messages{
      position:relative; min-height:360px; padding:12px 8px 16px;
      background:#efeae2; background-image:
        radial-gradient(circle at 20% 10%, rgba(0,0,0,.02) 2px, transparent 2px),
        radial-gradient(circle at 80% 0%, rgba(0,0,0,.02) 2px, transparent 2px),
        radial-gradient(circle at 0% 80%, rgba(0,0,0,.02) 2px, transparent 2px),
        radial-gradient(circle at 100% 90%, rgba(0,0,0,.02) 2px, transparent 2px);
      background-size: 280px 280px, 240px 240px, 260px 260px, 220px 220px;
    }
    .bubble{
      position:relative; display:inline-block; max-width:78%; margin:8px 6px;
      padding:10px 44px 10px 12px; line-height:1.4; font-size:14px;
      word-wrap:break-word; box-shadow:0 1px 1px rgba(0,0,0,.06)
    }
    .bubble.in{background:white; color:#111; border-radius:8px 8px 8px 0}
    .bubble.in::before{
      content:""; position:absolute; left:-8px; bottom:0;
      border-top:8px solid transparent; border-right:8px solid white
    }
    .bubble.out{background:#d9fdd3; color:#111; border-radius:8px 8px 0 8px;
      margin-left:auto; display:block
    }
    .bubble.out::after{
      content:""; position:absolute; right:-8px; bottom:0;
      border-top:8px solid transparent; border-left:8px solid #d9fdd3
    }
    .bubble .media{display:none; max-width:240px; width:100%; border-radius:12px; margin:-2px 0 6px}
    .bubble .meta{position:absolute; right:8px; bottom:4px; display:flex; align-items:center;
      gap:6px; font-size:11px; color:#667781
    }
    .meta .ticks{width:16px; height:16px; display:inline-block; vertical-align:middle}
    .ticks path{fill:#8696a0}
    .ticks.read path{fill:#53bdeb}

    /* ===== Forms ===== */
    .form-group{margin-bottom:16px}
    .form-label{
      display:block; font-size:14px; font-weight:600; color:var(--fb-text);
      margin-bottom:6px
    }
    .form-input, .form-textarea{
      width:100%; padding:12px 16px; border:1px solid var(--fb-border); border-radius:var(--fb-radius);
      background:var(--fb-white); font-size:14px; transition:border-color 0.2s
    }
    .form-input:focus, .form-textarea:focus{
      outline:none; border-color:var(--fb-blue); box-shadow:0 0 0 3px rgba(24,119,242,0.1)
    }
    .form-textarea{min-height:100px; resize:vertical}

    /* ===== Buttons ===== */
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 20px;
      border-radius:var(--fb-radius); font-weight:600; cursor:pointer;
      transition:all 0.2s; text-decoration:none; border:none; font-size:14px
    }
    .btn-primary{background:var(--fb-blue); color:white}
    .btn-primary:hover{background:var(--fb-blue-hover)}
    .btn-secondary{background:var(--fb-gray-light); color:var(--fb-text); border:1px solid var(--fb-border)}
    .btn-secondary:hover{background:var(--fb-border)}

    /* ===== Filter Section ===== */
    .filter-section{
      background:var(--fb-white); border-radius:var(--fb-radius-lg); padding:20px;
      box-shadow:var(--fb-shadow); border:1px solid var(--fb-border); margin-bottom:20px
    }
    .filter-header{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:16px
    }
    .filter-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .search-box{
      padding:8px 16px; border:1px solid var(--fb-border); border-radius:var(--fb-radius);
      background:var(--fb-white); font-size:14px; min-width:250px
    }
    .search-box:focus{outline:none; border-color:var(--fb-blue)}
    .filter-chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
    .chip{
      background:var(--fb-blue-light); border:1px solid var(--fb-blue); padding:6px 12px;
      border-radius:16px; display:flex; align-items:center; gap:6px;
      font-weight:600; font-size:12px; color:var(--fb-blue)
    }
    .chip .remove{
      width:16px; height:16px; border:0; border-radius:50%; background:var(--fb-blue);
      color:white; cursor:pointer; display:flex; align-items:center; justify-content:center;
      font-size:10px; font-weight:700
    }

    /* ===== Table ===== */
    .table-container{background:var(--fb-white); border-radius:var(--fb-radius-lg); overflow:hidden; box-shadow:var(--fb-shadow)}
    .table-header{
      padding:16px 20px; border-bottom:1px solid var(--fb-border);
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px
    }
    .table-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .table-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .data-table{
      width:100%; border-collapse:collapse; font-size:14px
    }
    .data-table th{
      background:var(--fb-gray-light); padding:12px 16px; text-align:left;
      font-weight:600; color:var(--fb-text); border-bottom:1px solid var(--fb-border)
    }
    .data-table td{
      padding:12px 16px; border-bottom:1px solid var(--fb-border); vertical-align:middle
    }
    .data-table tbody tr:hover{background:var(--fb-gray-light)}

    .badge{
      display:inline-block; padding:4px 8px; border-radius:12px;
      font-size:12px; font-weight:600; background:var(--fb-gray-light); color:var(--fb-text)
    }

    .select-btn{
      background:var(--fb-gray-light); color:var(--fb-text); border:1px solid var(--fb-border);
      border-radius:var(--fb-radius); padding:6px 12px; cursor:pointer; font-weight:600;
      transition:all 0.2s; font-size:12px
    }
    .select-btn:hover{background:var(--fb-border)}
    .select-btn.selected{background:var(--fb-blue); color:white; border-color:var(--fb-blue)}

    .sticky-footer{
      position:sticky; bottom:0; background:linear-gradient(180deg,rgba(240,242,245,0),rgba(240,242,245,1) 40%);
      padding:16px 20px; border-top:1px solid var(--fb-border); display:flex; justify-content:flex-end
    }

    /* ===== Modal ===== */
    .modal{
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5); z-index:2000
    }
    .modal-content{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background:white; border-radius:var(--fb-radius-lg); padding:24px;
      min-width:300px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:16px
    }
    .modal-title{font-size:18px; font-weight:600; color:var(--fb-text)}
    .modal-close{
      width:24px; height:24px; border:none; background:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center; color:var(--fb-gray-dark)
    }

    /* ===== Responsive Design ===== */
    @media (max-width:768px){
      .topbar__inner{flex-direction:column; height:auto; padding:12px 16px; gap:12px}
      .nav-tabs{order:2; width:100%; justify-content:center; flex-wrap:wrap}
      .topbar-actions{order:3}
      .main-container{padding:16px 12px}
      .page-title{font-size:24px}
      .content-grid{grid-template-columns:1fr}
      .wizard{grid-template-columns:1fr; gap:12px}
      .wizard::before{display:none}
      .table-header{flex-direction:column; align-items:stretch}
      .table-actions{justify-content:center}
    }
  </style>
</head>
<body>

  <!-- ===== Facebook-style Top Navigation ===== -->
  <nav class="topbar">
    <div class="topbar__inner">
      <!-- Brand -->
      <a href="{% url 'main_page' %}" class="brand">
        <div class="brand__logo">WA</div>
        <div class="brand__text">Campaign</div>
      </a>

      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <a href="{% url 'contest_home' %}" class="nav-tab">Contest</a>
        <a href="{% url 'crm_home' %}" class="nav-tab">CRM</a>
        <a href="{% url 'manage_customers' %}" class="nav-tab">Customers</a>
      </div>

      <!-- Actions -->
      <div class="topbar-actions">
        <button class="action-btn" title="New Campaign" onclick="scrollToSection('#compose')">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 5v14M5 12h14"/>
          </svg>
        </button>
        <button class="action-btn" title="Notifications">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 10-12 0v3.2c0 .53-.21 1.04-.59 1.41L4 17h5m6 0v1a3 3 0 11-6 0v-1"/>
          </svg>
        </button>
        <div class="user-avatar" title="You">{{ request.user.first_name|default:"U"|slice:":1"|upper }}</div>
      </div>
    </div>
  </nav>

  <!-- ===== Main Content ===== -->
  <div class="main-container">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">WhatsApp Campaign</h1>
      <p class="page-subtitle">Create and send bulk WhatsApp messages to your customers</p>
    </div>

    {% csrf_token %}

    <!-- Steps Wizard -->
    <div class="wizard">
      <button class="wizard-step" data-step="1" onclick="scrollToSection('#compose')">
        <span class="wizard-badge">1</span>
        <div>
          <div class="wizard-title">Compose your message</div>
          <div class="wizard-desc">Write text, add image, set time.</div>
        </div>
      </button>

      <button class="wizard-step" data-step="2" onclick="scrollToSection('#filter')">
        <span class="wizard-badge">2</span>
        <div>
          <div class="wizard-title">Choose recipients</div>
          <div class="wizard-desc">Use filters & select who gets it.</div>
        </div>
      </button>

      <button class="wizard-step" data-step="3" onclick="scrollToSection('#preview')">
        <span class="wizard-badge">3</span>
        <div>
          <div class="wizard-title">Review & send</div>
          <div class="wizard-desc">Double-check preview, then send.</div>
        </div>
      </button>
    </div>

    <!-- Two Column Layout -->
    <div class="content-grid">
      <!-- WhatsApp Preview -->
      <div class="preview-section" id="preview">
        <h3 class="card-title">Message Preview</h3>
        <div class="wa-phone">
          <div class="wa-chat-header">
            <div class="wa-chat-avatar" id="headerAvatar">C</div>
            <div class="wa-chat-info">
              <div class="wa-chat-name" id="headerName">Customer</div>
              <div class="wa-chat-status">online</div>
            </div>
          </div>

          <div class="wa-messages">
            <!-- Sample incoming bubble for context -->
            <div class="bubble in">
              <div>Hi! How can we help today?</div>
              <div class="meta"><span>10:42</span></div>
            </div>

            <!-- Outgoing bubble driven by inputs -->
            <div class="bubble out" id="waOutgoing">
              <img id="receiverImage" class="media" alt="WhatsApp Image Preview">
              <div id="receiverMessage">Enter your message to see preview...</div>
              <div class="meta">
                <span id="receiverTime">10:45</span>
                <svg class="ticks read" viewBox="0 0 16 15" aria-hidden="true">
                  <path d="M10.5 3.5l-4.2 6.1-2.3-2.3-.9.9 3.3 3.3L11.4 4.4l-.9-.9zM15 3.5l-4.2 6.1-.8-.8.9-.9L15 1.7l.9.9-.9.9z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Compose Section -->
      <div class="compose-section" id="compose">
        <h3 class="card-title">Compose Message</h3>
        
        <div class="form-group">
          <label for="waPreviewName" class="form-label">Preview Name</label>
          <input type="text" id="waPreviewName" class="form-input" value="Customer" oninput="updatePreview()" placeholder="Enter preview name (e.g., Company)">
        </div>

        <div class="form-group">
          <label for="waImageFile" class="form-label">Image (Optional)</label>
          <input type="file" id="waImageFile" class="form-input" accept="image/*" onchange="loadLocalImage(event)">
        </div>

        <div class="form-group">
          <label for="waMessage" class="form-label">Message</label>
          <textarea id="waMessage" class="form-textarea" oninput="updatePreview()" placeholder="Enter your message here..."></textarea>
        </div>

        <div class="form-group">
          <label for="waTime" class="form-label">Time</label>
          <input type="text" id="waTime" class="form-input" value="10:45 AM" oninput="updatePreview()">
        </div>

        <div style="display:flex; gap:8px; margin-top:16px;">
          <button type="button" class="btn btn-secondary" onclick="selectAll()" id="selectAllBtn">Select All</button>
          <button type="button" class="btn btn-primary" onclick="sendBulkMessage()" id="sendBtn">Send Message</button>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section" id="filter">
      <div class="filter-header">
        <h3 class="filter-title">Audience Filters</h3>
        <input id="tableFilter" type="text" class="search-box" placeholder="Search name or phone...">
      </div>
      <div class="filter-chips" id="chipRow">
        <button class="btn btn-secondary" type="button" onclick="showFilterModal()">+ Add filter</button>
        <button class="btn btn-primary" type="button" onclick="selectAll()">Select all</button>
        <button class="btn btn-secondary" type="button" onclick="clearFilters()">Clear filters</button>
      </div>
      <div class="filter-chips" id="activeFilters" style="margin-top:12px;"></div>
    </div>

    <!-- Recipients Table -->
    <div class="table-container">
      <div class="table-header">
        <h3 class="table-title">Recipients</h3>
        <div class="table-actions">
          <button class="btn btn-primary" onclick="sendBulkMessage()">Send Message</button>
        </div>
      </div>

      <table class="data-table" id="contactsList">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone Number</th>
            <th>State</th>
            <th>Gender</th>
            <th>Marital Status</th>
            <th>Age</th>
            <th>City</th>
            <th style="text-align:right">Select</th>
          </tr>
        </thead>
        <tbody>
          {% for contact in contacts %}
          <tr data-state="{{ contact.state|default:'' }}" data-gender="{{ contact.gender }}" data-marital="{{ contact.marital_status }}">
            <td>{{ contact.name }}</td>
            <td>{{ contact.phone_number }}</td>
            <td><span class="badge">{{ contact.state|default:"N/A" }}</span></td>
            <td><span class="badge">{{ contact.get_gender_display }}</span></td>
            <td><span class="badge">{{ contact.get_marital_status_display }}</span></td>
            <td><span class="badge">{{ contact.age|default:"N/A" }}</span></td>
            <td><span class="badge">{{ contact.city|default:"N/A" }}</span></td>
            <td style="text-align:right">
              <button class="select-btn" onclick="toggleSelect('{{ contact.customer_id }}')" id="selectBtn{{ contact.customer_id }}">Select</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Filter Modal -->
  <div id="filterModal" class="modal" onclick="hideFilterModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Add Filter</h3>
        <button class="modal-close" onclick="hideFilterModal()">×</button>
      </div>
      
      <div class="form-group">
        <label class="form-label">Filter Type:</label>
        <select id="filterType" class="form-input" onchange="updateFilterValueOptions()">
          <option value="state">State</option>
          <option value="gender">Gender</option>
          <option value="marital_status">Marital Status</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Value:</label>
        <select id="filterValue" class="form-input">
          <!-- Options populated by JavaScript -->
        </select>
      </div>
      
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button class="btn btn-secondary" onclick="hideFilterModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addFilter()">Add Filter</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Data from Django ===== */
    const contactsData = {{ contacts_json|safe }};
    const stateChoices = [
      {% for value, display in state_choices %}
        {value: '{{ value }}', display: '{{ display }}'},
      {% endfor %}
    ];
    const genderChoices = [
      {% for value, display in gender_choices %}
        {value: '{{ value }}', display: '{{ display }}'},
      {% endfor %}
    ];
    const maritalChoices = [
      {% for value, display in marital_choices %}
        {value: '{{ value }}', display: '{{ display }}'},
      {% endfor %}
    ];
    
    /* ===== Active Filters ===== */
    let activeFilters = [];
    
    /* ===== Filter Modal Functions ===== */
    function showFilterModal() {
      document.getElementById('filterModal').style.display = 'block';
      updateFilterValueOptions();
    }
    
    function hideFilterModal() {
      document.getElementById('filterModal').style.display = 'none';
    }
    
    function updateFilterValueOptions() {
      const filterType = document.getElementById('filterType').value;
      const filterValue = document.getElementById('filterValue');
      
      let choices = [];
      if (filterType === 'state') choices = stateChoices;
      else if (filterType === 'gender') choices = genderChoices;
      else if (filterType === 'marital_status') choices = maritalChoices;
      
      filterValue.innerHTML = '';
      choices.forEach(choice => {
        if (choice.value !== 'N/A') {
          const option = document.createElement('option');
          option.value = choice.value;
          option.textContent = choice.display;
          filterValue.appendChild(option);
        }
      });
    }
    
    function addFilter() {
      const filterType = document.getElementById('filterType').value;
      const filterValue = document.getElementById('filterValue').value;
      const filterDisplay = document.getElementById('filterValue').selectedOptions[0].textContent;
      
      const existingFilter = activeFilters.find(f => f.type === filterType && f.value === filterValue);
      if (existingFilter) {
        alert('This filter is already active');
        return;
      }
      
      activeFilters.push({type: filterType, value: filterValue, display: filterDisplay});
      updateActiveFiltersDisplay();
      applyFilters();
      hideFilterModal();
    }
    
    function removeFilter(index) {
      activeFilters.splice(index, 1);
      updateActiveFiltersDisplay();
      applyFilters();
    }
    
    function clearFilters() {
      activeFilters = [];
      updateActiveFiltersDisplay();
      applyFilters();
    }
    
    function updateActiveFiltersDisplay() {
      const container = document.getElementById('activeFilters');
      container.innerHTML = '';
      
      activeFilters.forEach((filter, index) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `${filter.type}: ${filter.display} <button class="remove" onclick="event.stopPropagation(); removeFilter(${index})">×</button>`;
        container.appendChild(chip);
      });
    }
    
    function applyFilters() {
      const searchQuery = document.getElementById('tableFilter').value.toLowerCase();
      
      document.querySelectorAll('#contactsList tbody tr').forEach(tr => {
        const name = tr.children[0].textContent.toLowerCase();
        const phone = tr.children[1].textContent.toLowerCase();
        const state = tr.getAttribute('data-state');
        const gender = tr.getAttribute('data-gender');
        const marital = tr.getAttribute('data-marital');
        
        const matchesSearch = searchQuery === '' || 
          name.includes(searchQuery) || phone.includes(searchQuery);
        
        const matchesFilters = activeFilters.every(filter => {
          if (filter.type === 'state') return state === filter.value;
          if (filter.type === 'gender') return gender === filter.value;
          if (filter.type === 'marital_status') return marital === filter.value;
          return true;
        });
        
        tr.style.display = (matchesSearch && matchesFilters) ? '' : 'none';
      });
    }
    
    // Event listeners
    document.getElementById('tableFilter').addEventListener('input', applyFilters);
    document.getElementById('filterType').addEventListener('change', updateFilterValueOptions);

    /* ===== Wizard + smooth scroll ===== */
    function scrollToSection(sel){ 
      const el=document.querySelector(sel); 
      if(el){ 
        el.scrollIntoView({behavior:'smooth', block:'start'}); 
      } 
    }
    
    function setStepState(n,state){
      const step=document.querySelector(`.wizard-step[data-step="${n}"]`);
      if(!step) return;
      step.classList.remove('current','complete');
      if(state==='current') step.classList.add('current');
      if(state==='complete') step.classList.add('complete');
    }
    
    function updateWizard(){
      const hasMessage=(document.getElementById('waMessage')?.value||'').trim().length>0;
      const hasRecipients=typeof selected!=='undefined' ? selected.size>0 : false;
      document.querySelectorAll('.wizard-step').forEach(s=>s.classList.remove('current','complete'));
      if(!hasMessage){ setStepState(1,'current'); return; }
      if(hasMessage && !hasRecipients){ setStepState(1,'complete'); setStepState(2,'current'); return; }
      setStepState(1,'complete'); setStepState(2,'complete'); setStepState(3,'current');
    }

    /* ===== WhatsApp Preview ===== */
    let currentImageUrl = null;

    function updatePreview() {
      const message = document.getElementById('waMessage').value || 'Enter your message to see preview...';
      const timeValue = document.getElementById('waTime').value || '10:45 AM';
      const previewName = document.getElementById('waPreviewName').value || 'Customer';

      document.getElementById('receiverMessage').textContent = message;
      const displayTime = timeValue.replace(/\s?(AM|PM)$/i,'');
      document.getElementById('receiverTime').textContent = displayTime || '10:45';
      document.getElementById('headerName').textContent = previewName;
      document.getElementById('headerAvatar').textContent = previewName.charAt(0).toUpperCase();

      localStorage.setItem('messageData', JSON.stringify({
        message, time: timeValue, imageUrl: currentImageUrl, previewName
      }));
      updateWizard();
    }

    function loadLocalImage(event) {
      const file = event.target.files[0];
      const imageElement = document.getElementById('receiverImage');

      if (file) {
        const formData = new FormData();
        formData.append('image', file);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch('/upload-image/', { method:'POST', headers:{ 'X-CSRFToken': csrfToken }, body: formData })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            currentImageUrl = data.file_url;
            imageElement.src = currentImageUrl;
            imageElement.style.display = 'block';
            updatePreview();
          } else { alert('Failed to upload image. Please try again.'); }
        })
        .catch(err => { console.error(err); alert('Error uploading image.'); });
      } else {
        imageElement.style.display = 'none';
        currentImageUrl = null;
        updatePreview();
      }
    }

    // Selection logic
    const selected = new Set();
    const contacts = JSON.parse('{{ contacts_json|default:"[]"|escapejs }}');

    function toggleSelect(contactId) {
      const btn = document.getElementById(`selectBtn${contactId}`);
      if (selected.has(contactId)) {
        selected.delete(contactId);
        btn.classList.remove('selected'); btn.textContent = 'Select';
      } else {
        selected.add(contactId);
        btn.classList.add('selected'); btn.textContent = 'Selected';
      }
      updateSelectAllBtn(); updateWizard();
    }

    function selectAll() {
      if (selected.size === contacts.length) {
        selected.clear();
        contacts.forEach(c => { const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.remove('selected'); b.textContent='Select'; } });
      } else {
        contacts.forEach(c => { selected.add(c.id); const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.add('selected'); b.textContent='Selected'; } });
      }
      updateSelectAllBtn(); updateWizard();
    }

    function updateSelectAllBtn() {
      const btn = document.getElementById('selectAllBtn');
      if (!btn) return;
      btn.textContent = (selected.size === contacts.length && contacts.length>0) ? 'Deselect All' : 'Select All';
    }

    function sendBulkMessage() {
      if (selected.size === 0) { alert('Please select at least one recipient.'); return; }
      const message = document.getElementById('waMessage').value;
      if (!message) { alert('Please enter a message to send.'); return; }
      const time = document.getElementById('waTime').value;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      fetch('/send-bulk/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ message, time, image_url: currentImageUrl, recipients: Array.from(selected) })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          // Reset
          document.getElementById('waMessage').value=''; document.getElementById('waTime').value='10:45 AM';
          document.getElementById('waImageFile').value=''; const img=document.getElementById('receiverImage'); img.style.display='none';
          currentImageUrl=null; updatePreview();
          selected.clear(); contacts.forEach(c=>{ const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.remove('selected'); b.textContent='Select'; } });
          updateSelectAllBtn(); localStorage.removeItem('messageData');
        } else { alert('Failed to send message: ' + (data.message || 'Please try again.')); }
      })
      .catch(err => { console.error(err); alert('An error occurred while sending the message.'); });
    }

    // Initialize on load
    (function init(){
      const data = JSON.parse(localStorage.getItem('messageData') || '{}');
      if (data.message) { document.getElementById('waMessage').value = data.message; document.getElementById('receiverMessage').textContent = data.message; }
      if (data.time) {
        document.getElementById('waTime').value = data.time;
        document.getElementById('receiverTime').textContent = (data.time||'').replace(/\s?(AM|PM)$/i,'') || '10:45';
      }
      if (data.imageUrl) { currentImageUrl = data.imageUrl; const img = document.getElementById('receiverImage'); img.src = data.imageUrl; img.style.display='block'; }
      if (data.previewName) {
        document.getElementById('waPreviewName').value = data.previewName;
        document.getElementById('headerName').textContent = data.previewName;
        document.getElementById('headerAvatar').textContent = data.previewName.charAt(0).toUpperCase();
      }
      updatePreview(); updateWizard();
    })();
  </script>
</body>
</html>

