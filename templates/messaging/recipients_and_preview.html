<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Bulk Message - Recipients & Preview</title>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <style>
    /* ===== Modern CRM theme ===== */
    :root{
      --bg:#f3f6fb; --card:#fff; --text:#0f172a; --muted:#667085; --line:#e5e7eb;
      --brand:#0ea5e9; --brand-strong:#0284c7; --accent:#22c55e; --radius:14px;
      --shadow:0 6px 20px rgba(2,8,23,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Top navbar */
  .topbar {
    position: sticky; top: 0; z-index: 1000;
    background: #ffffff; border-bottom: 1px solid #e5e7eb;
  }
  .topbar__inner {
    max-width: 1280px; margin: 0 auto;
    display: grid; grid-template-columns: 280px 1fr 280px;
    align-items: center; gap: 12px; padding: 8px 16px;
  }
  .brand { display:flex; align-items:center; gap:10px; text-decoration:none; }
  .brand__logo { width: 36px; height: 36px; border-radius: 8px; display:grid; place-items:center; background:#0ea5e9; color:#fff; font-weight:800; font-size:18px; }
  .brand__text { color:#0f172a; font-weight:800; letter-spacing:.2px }

  /* Tabs now inline */
  .tabs { display: flex; justify-content: center; gap: 6px; }
  .tab {
    min-width: 100px; height: 40px; display: grid; place-items: center;
    border-radius: 10px; color: #64748b; text-decoration: none; font-weight: 700;
  }
  .tab:hover { background: #f1f5f9; color:#0f172a }
  .tab--active { color:#0ea5e9; }
  .tab__icon { display:flex; align-items:center; gap:8px; font-size: 14px }

  .actions { display: flex; justify-content: flex-end; gap: 8px; align-items: center; }
  .action { width: 40px; height: 40px; border-radius: 999px; display:grid; place-items:center; background:#f1f5f9; border:1px solid #e5e7eb; }
  .action:hover { background:#e2e8f0 }
  .avatar { width: 36px; height: 36px; border-radius: 999px; background:#0ea5e9; color:#fff; display:grid; place-items:center; font-weight:800 }


  /* Sidebar */
  .leftnav {
    background:#ffffff; border:1px solid #e5e7eb;
    border-radius: 12px; box-shadow: 0 6px 18px rgba(2,8,23,.06);
    height: calc(100vh - 120px); position: sticky; top: 88px; padding: 12px;
  }
  .leftnav__title { font-size: 12px; font-weight: 800; color:#64748b; margin: 6px 8px 12px }
  .leftnav a {
    display:flex; align-items:center; gap: 10px; text-decoration: none;
    color:#0f172a; border-radius: 10px; padding: 10px 12px; font-weight: 600;
  }
  .leftnav a:hover { background:#f8fafc }
  .leftnav a.active { background:#eff6ff; color:#0b5cab; border:1px solid #bfdbfe }
  .ln-icon { width: 18px; height: 18px; color:#64748b }

    /* Layout with sidebar */
    .layout{
  max-width:1280px;
  margin:22px auto;
  display:grid;
  gap:20px;
  grid-template-columns:1fr;   /* â¬… single column */
  align-items:start;
  padding:0 20px;
}
    /* Main page grid */
    .page{display:grid;gap:20px;grid-template-columns:1.1fr .9fr;grid-template-areas:
          "steps steps" "preview compose" "segments segments" "table table";}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0 0 12px;font-size:16px}

    /* Steps */
    .wizard{grid-area:steps;display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;padding:16px;position:relative}
    .wizard__track{position:absolute;left:32px;right:32px;top:42px;height:2px;background:#e5e7eb}
    .wizard__step{background:transparent;border:0;text-align:left;display:flex;gap:12px;align-items:flex-start;cursor:pointer;padding:8px;border-radius:12px;transition:.15s}
    .wizard__step:hover{background:#f8fafc}
    .wizard__badge{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#e5e7eb;color:#111827;font-weight:800;border:2px solid #e5e7eb;flex:0 0 auto}
    .wizard__title{font-weight:700;font-size:14px}
    .wizard__desc{font-size:12px;color:var(--muted);margin-top:4px}
    .wizard__step.is-complete .wizard__badge{background:#22c55e;border-color:#16a34a;color:#fff}
    .wizard__step.is-current .wizard__badge{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:0 0 0 4px rgba(14,165,233,.22)}
    .wizard__step.is-current .wizard__title{color:var(--brand-strong)}

    /* Labels, inputs, buttons */
    .preview{grid-area:preview;padding:18px}
    .compose{grid-area:compose;padding:18px}
    label{display:block;font-size:12px;color:#475569;font-weight:700;margin:8px 0 6px}
    input[type="text"],textarea,input[type="file"]{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px;outline:none}
    textarea{min-height:100px;resize:vertical}
    input:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(14,165,233,.25)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid transparent;font-weight:700;cursor:pointer;transition:.15s}
    .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{background:var(--brand-strong)}
    .btn-ghost{background:#eef6ff;color:#0b5cab;border-color:#dbeafe}

    /* ===== WhatsApp-like preview ===== */
    .wa-phone{
      background:#0ea5e9;
      border:8px solid #1f2937;
      border-radius:22px;
      overflow:hidden;
      width:360px; max-width:100%;
      margin:auto;
      box-shadow:0 18px 34px rgba(2,8,23,.18);
    }
    .wa-chat-header{
      background:#075e54; color:#fff;
      padding:10px 12px; display:flex; align-items:center; gap:10px;
    }
    .wa-chat-avatar{width:32px;height:32px;border-radius:50%;background:#25d366;display:grid;place-items:center;font-weight:800}
    .wa-chat-info{flex:1}
    .wa-chat-name{font-weight:700}
    /* Wallpaper */
    .wa-messages{
      position:relative; min-height:360px; padding:10px 8px 14px;
      background:#efeae2;
      background-image:
        radial-gradient(circle at 20% 10%, rgba(0,0,0,.02) 2px, transparent 2px),
        radial-gradient(circle at 80% 0%, rgba(0,0,0,.02) 2px, transparent 2px),
        radial-gradient(circle at 0% 80%, rgba(0,0,0,.02) 2px, transparent 2px),
        radial-gradient(circle at 100% 90%, rgba(0,0,0,.02) 2px, transparent 2px);
      background-size: 280px 280px, 240px 240px, 260px 260px, 220px 220px;
    }
    /* Bubbles */
    .bubble{
      position:relative; display:inline-block; max-width:78%;
      margin:6px 6px; padding:8px 44px 8px 10px;
      line-height:1.4; font-size:14px; word-wrap:break-word;
      box-shadow:0 1px 1px rgba(0,0,0,.06);
    }
    .bubble.in{ background:#fff; color:#111; border-radius:8px 8px 8px 0; }
    .bubble.in::before{
      content:""; position:absolute; left:-8px; bottom:0;
      border-top:8px solid transparent; border-right:8px solid #fff;
    }
    .bubble.out{ background:#d9fdd3; color:#111; border-radius:8px 8px 0 8px; margin-left:auto; display:block; }
    .bubble.out::after{
      content:""; position:absolute; right:-8px; bottom:0;
      border-top:8px solid transparent; border-left:8px solid #d9fdd3;
    }
    .bubble .media{ display:none; max-width:240px; width:100%; border-radius:12px; margin:-2px 0 6px; }
    .bubble .meta{ position:absolute; right:8px; bottom:4px; display:inline-flex; align-items:center; gap:6px; font-size:11px; color:#667781; }
    .meta .ticks{ width:16px; height:16px; display:inline-block; vertical-align:middle }
    .ticks path{ fill:#8696a0 }         /* delivered (grey) */
    .ticks.read path{ fill:#53bdeb }    /* read (blue)  */

    /* Segments (chips row) */
    .segments{grid-area:segments;padding:14px 16px}
    .seg-head{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
    .seg-title{font-weight:800}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{background:#f1f5f9;border:1px solid var(--line);padding:8px 12px;border-radius:999px;display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px}
    .chip.good{background:#ecfeff;border-color:#a5f3fc}
    .chip .x{width:18px;height:18px;border:0;border-radius:999px;background:#e2e8f0;cursor:pointer}
    .chip.is-on{outline:2px solid var(--brand);}

    /* Recipients table */
    .recipients{grid-area:table;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#f8fafc;text-align:left;padding:12px 14px;font-size:12px;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--line)}
    td{padding:12px 14px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#f9fbff}
    .right{text-align:right}
    .select-btn{background:#eef6ff;color:#0b5cab;border:1px solid #dbeafe;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .select-btn.selected{background:var(--brand);color:#fff;border-color:var(--brand)}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;background:#f1f5f9;color:#64748b;white-space:nowrap}
    .toolbar{display:flex;gap:10px;margin:12px 14px;justify-content:flex-end}
    .sticky-footer{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(243,246,251,0),rgba(243,246,251,1) 40%);padding:14px;border-top:1px solid var(--line)}

    /* Responsive */
    @media (max-width:1100px){
      .page{grid-template-columns:1fr;grid-template-areas:"steps" "preview" "compose" "segments" "table"}
      .layout{grid-template-columns:1fr}
      .sidebar{display:none}
    }
  </style>
</head>
<body>

  <!-- Top NAV -->
  <nav class="topbar">
  <div class="topbar__inner">
    <!-- Left: brand -->
    <a href="{% url 'main_page' %}" class="brand">
      <div class="brand__logo">WA</div>
      <div class="brand__text">Campaign</div>
    </a>

    <!-- Center: tabs (moved up) -->
    <div class="tabs"> 
      <!-- Campaigns -->
      <a href="{% url 'main_page' %}" class="tab {% if request.path == '/' %}tab--active{% endif %}">
        <span class="tab__icon">
          <!-- SAME AS LEFT NAV home icon -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12l9-9 9 9" />
            <path d="M9 21V9h6v12" />
          </svg>
          Campaign
        </span>
      </a>

      <!-- Customers -->
      <a href="{% url 'manage_customers' %}" class="tab {% if request.path|slice:':10' == '/customers' %}tab--active{% endif %}">
        <span class="tab__icon">
          <!-- SAME AS LEFT NAV users icon -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 11a4 4 0 1 0-8 0" />
            <path d="M3 21a7 7 0 0 1 18 0" />
          </svg>
          Customers
        </span>
      </a>

      <!-- CRM -->
      <a href="{% url 'crm_dashboard' %}" class="tab {% if request.resolver_match.url_name == 'crm_dashboard' %}tab--active{% endif %}">
        <span class="tab__icon">
          <!-- SAME AS LEFT NAV grid icon -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          CRM
        </span>
      </a>

      <!-- Analytics -->
      <a href="{% url 'analytics_dashboard' %}" class="tab {% if request.resolver_match.url_name == 'analytics_dashboard' %}tab--active{% endif %}">
        <span class="tab__icon">
          <!-- SAME AS LEFT NAV bar chart icon -->
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
            <line x1="15" y1="21" x2="15" y2="4"></line>
            <line x1="20" y1="21" x2="20" y2="17"></line>
          </svg>
          Analytics
        </span>
      </a>
    </div>


    <!-- Right: actions -->
    <div class="actions">
      <button class="action" title="New Campaign" onclick="scrollToSection('#compose')" aria-label="New Campaign">
        <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button class="action" title="Notifications" aria-label="Notifications">
        <svg viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 10-12 0v3.2c0 .53-.21 1.04-.59 1.41L4 17h5m6 0v1a3 3 0 11-6 0v-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <div class="avatar" title="You">{{ request.user.first_name|default:"U"|slice:":1"|upper }}</div>
    </div>
  </div>
</nav>



  <div class="layout">
    <!-- Sidebar -->
    <!-- Main -->
    <main class="page">
      {% csrf_token %}

      <!-- STEPS -->
      <section class="wizard card" id="wizard">

        <button class="wizard__step" data-step="1" onclick="scrollToSection('#compose')">
          <span class="wizard__badge">1</span>
          <div>
            <div class="wizard__title">Compose your message</div>
            <div class="wizard__desc">Write text, add image, set time.</div>
          </div>
        </button>

        <button class="wizard__step" data-step="2" onclick="scrollToSection('#segments')">
          <span class="wizard__badge">2</span>
          <div>
            <div class="wizard__title">Choose recipients</div>
            <div class="wizard__desc">Use filters & select who gets it.</div>
          </div>
        </button>

        <button class="wizard__step" data-step="3" onclick="scrollToSection('#preview')">
          <span class="wizard__badge">3</span>
          <div>
            <div class="wizard__title">Review & send</div>
            <div class="wizard__desc">Double-check preview, then send.</div>
          </div>
        </button>
      </section>

      <!-- PREVIEW (WhatsApp-like) -->
      <section class="preview card" id="preview">
        <h2>Message preview</h2>

        <div class="wa-phone">
          <div class="wa-chat-header">
            <div class="wa-chat-avatar" id="headerAvatar">C</div>
            <div class="wa-chat-info">
              <div class="wa-chat-name" id="headerName">Customer</div>
              <div class="wa-chat-status" style="font-size:12px;color:#a5f3fc">online</div>
            </div>
          </div>

          <div class="wa-messages">
            <!-- sample incoming bubble for context -->
            <div class="bubble in">
              <div>Hi! How can we help today?</div>
              <div class="meta"><span>10:42</span></div>
            </div>

            <!-- outgoing bubble driven by your inputs -->
            <div class="bubble out" id="waOutgoing">
              <img id="receiverImage" class="media" alt="WhatsApp Image Preview">
              <div id="receiverMessage">Enter your message to see preview...</div>
              <div class="meta">
                <span id="receiverTime">10:45</span>
                <!-- double-tick (read by default) -->
                <svg class="ticks read" viewBox="0 0 16 15" aria-hidden="true">
                  <path d="M10.5 3.5l-4.2 6.1-2.3-2.3-.9.9 3.3 3.3L11.4 4.4l-.9-.9zM15 3.5l-4.2 6.1-.8-.8.9-.9L15 1.7l.9.9-.9.9z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- COMPOSE -->
      <section class="compose card" id="compose">
        <h2>Compose</h2>
        <label for="waPreviewName">Preview Name</label>
        <input type="text" id="waPreviewName" value="Customer" oninput="updatePreview()" placeholder="Enter preview name (e.g., Company)">

        <label for="waImageFile">Image (local file)</label>
        <input type="file" id="waImageFile" accept="image/*" onchange="loadLocalImage(event)">

        <label for="waMessage">Message</label>
        <textarea id="waMessage" oninput="updatePreview()" placeholder="Enter your message here..."></textarea>

        <label for="waTime">Time</label>
        <input type="text" id="waTime" value="10:45 AM" oninput="updatePreview()">

        <div class="toolbar">
          <button type="button" class="btn btn-ghost" onclick="selectAll()" id="selectAllBtn">Select All</button>
          <button type="button" class="btn btn-primary" onclick="sendBulkMessage()" id="sendBtn">Send Message</button>
        </div>
      </section>

      <!-- SEGMENT CHIPS -->
      <section class="segments card" id="segments">
        <div class="seg-head">
          <div class="seg-title">Audience filters</div>
          <input id="tableFilter" type="text" placeholder="Search name or phoneâ€¦" style="max-width:280px;padding:10px 12px;border:1px solid var(--line);border-radius:10px;">
        </div>
        <div class="chips" id="chipRow">
          <!-- Dynamic filter chips will be added here -->
          <button class="btn btn-ghost" type="button" onclick="showFilterModal()">+ Add filter</button>
          <button class="btn btn-primary" type="button" onclick="selectAll()">Select all</button>
          <button class="btn btn-secondary" type="button" onclick="clearFilters()">Clear filters</button>
        </div>
        
        <!-- Active Filters Display -->
        <div class="chips" id="activeFilters" style="margin-top:10px;"></div>
      </section>
      
      <!-- Filter Modal -->
      <div id="filterModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;" onclick="hideFilterModal()">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;padding:20px;min-width:300px;" onclick="event.stopPropagation()">
          <h3 style="margin:0 0 15px 0;">Add Filter</h3>
          
          <label style="display:block;margin-bottom:5px;font-weight:600;">Filter Type:</label>
          <select id="filterType" style="width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;margin-bottom:15px;">
            <option value="state">State</option>
            <option value="gender">Gender</option>
            <option value="race">Race</option>
          </select>
          
          <label style="display:block;margin-bottom:5px;font-weight:600;">Value:</label>
          <select id="filterValue" style="width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;margin-bottom:15px;">
            <!-- Options populated by JavaScript -->
          </select>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="hideFilterModal()">Cancel</button>
            <button class="btn btn-primary" onclick="addFilter()">Add Filter</button>
          </div>
        </div>
      </div>

      <!-- RECIPIENTS -->
      <section class="recipients card" id="recipients">
        <h2 style="padding:14px 14px 0 14px">Recipients</h2>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone Number</th>
              <th>State</th>
              <th>Gender</th>
              <th>Race</th>
              <th class="right">Select</th>
            </tr>
          </thead>
          <tbody id="contactsList">
            {% for contact in contacts %}
            <tr data-state="{{ contact.state }}" data-gender="{{ contact.gender }}" data-race="{{ contact.race }}">
              <td>{{ contact.name }}</td>
              <td>{{ contact.phone_number }}</td>
              <td><span class="badge">{{ contact.get_state_display }}</span></td>
              <td><span class="badge">{{ contact.get_gender_display }}</span></td>
              <td><span class="badge">{{ contact.get_race_display }}</span></td>
              <td class="right">
                <button class="select-btn" onclick="toggleSelect('{{ contact.id }}')" id="selectBtn{{ contact.id }}">Select</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="sticky-footer">
          <button type="button" class="btn btn-primary" onclick="sendBulkMessage()">Send</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* ===== Data from Django ===== */
    const contactsData = {{ contacts_json|safe }};
    const stateChoices = [
      {% for value, display in state_choices %}
        {value: '{{ value }}', display: '{{ display }}'},
      {% endfor %}
    ];
    const genderChoices = [
      {% for value, display in gender_choices %}
        {value: '{{ value }}', display: '{{ display }}'},
      {% endfor %}
    ];
    const raceChoices = [
      {% for value, display in race_choices %}
        {value: '{{ value }}', display: '{{ display }}'},
      {% endfor %}
    ];
    
    /* ===== Active Filters ===== */
    let activeFilters = [];
    
    /* ===== Filter Modal Functions ===== */
    function showFilterModal() {
      document.getElementById('filterModal').style.display = 'block';
      updateFilterValueOptions();
    }
    
    function hideFilterModal() {
      document.getElementById('filterModal').style.display = 'none';
    }
    
    function updateFilterValueOptions() {
      const filterType = document.getElementById('filterType').value;
      const filterValue = document.getElementById('filterValue');
      
      let choices = [];
      if (filterType === 'state') choices = stateChoices;
      else if (filterType === 'gender') choices = genderChoices;
      else if (filterType === 'race') choices = raceChoices;
      
      filterValue.innerHTML = '';
      choices.forEach(choice => {
        if (choice.value !== 'N/A') { // Skip N/A in filters
          const option = document.createElement('option');
          option.value = choice.value;
          option.textContent = choice.display;
          filterValue.appendChild(option);
        }
      });
    }
    
    function addFilter() {
      const filterType = document.getElementById('filterType').value;
      const filterValue = document.getElementById('filterValue').value;
      const filterDisplay = document.getElementById('filterValue').selectedOptions[0].textContent;
      
      // Check if filter already exists
      const existingFilter = activeFilters.find(f => f.type === filterType && f.value === filterValue);
      if (existingFilter) {
        alert('This filter is already active');
        return;
      }
      
      // Add to active filters
      activeFilters.push({type: filterType, value: filterValue, display: filterDisplay});
      updateActiveFiltersDisplay();
      applyFilters();
      hideFilterModal();
    }
    
    function removeFilter(index) {
      activeFilters.splice(index, 1);
      updateActiveFiltersDisplay();
      applyFilters();
    }
    
    function clearFilters() {
      activeFilters = [];
      updateActiveFiltersDisplay();
      applyFilters();
    }
    
    function updateActiveFiltersDisplay() {
      const container = document.getElementById('activeFilters');
      container.innerHTML = '';
      
      activeFilters.forEach((filter, index) => {
        const chip = document.createElement('span');
        chip.className = 'chip good';
        chip.innerHTML = `${filter.type}: ${filter.display} <button class="x" onclick="event.stopPropagation(); removeFilter(${index})">Ã—</button>`;
        container.appendChild(chip);
      });
    }
    
    function applyFilters() {
      const searchQuery = document.getElementById('tableFilter').value.toLowerCase();
      
      document.querySelectorAll('#contactsList tr').forEach(tr => {
        const name = tr.children[0].textContent.toLowerCase();
        const phone = tr.children[1].textContent.toLowerCase();
        const state = tr.getAttribute('data-state');
        const gender = tr.getAttribute('data-gender');
        const race = tr.getAttribute('data-race');
        
        // Check search filter
        const matchesSearch = searchQuery === '' || 
          name.includes(searchQuery) || phone.includes(searchQuery);
        
        // Check demographic filters
        const matchesFilters = activeFilters.every(filter => {
          if (filter.type === 'state') return state === filter.value;
          if (filter.type === 'gender') return gender === filter.value;
          if (filter.type === 'race') return race === filter.value;
          return true;
        });
        
        tr.style.display = (matchesSearch && matchesFilters) ? '' : 'none';
      });
      
      updateRecipientCount();
    }
    
    function updateRecipientCount() {
      const visibleRows = document.querySelectorAll('#contactsList tr[style=""], #contactsList tr:not([style])').length;
      // You can add a counter display here if needed
    }
    
    // Event listener for search
    document.getElementById('tableFilter').addEventListener('input', applyFilters);
    
    // Update filter type change
    document.getElementById('filterType').addEventListener('change', updateFilterValueOptions);
    /* ===== Wizard + smooth scroll ===== */
    function scrollToSection(sel){ const el=document.querySelector(sel); if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); } }
    function setStepState(n,state){
      const step=document.querySelector(`.wizard__step[data-step="${n}"]`);
      if(!step) return;
      step.classList.remove('is-current','is-complete');
      if(state==='current') step.classList.add('is-current');
      if(state==='complete') step.classList.add('is-complete');
    }
    function updateWizard(){
      const hasMessage=(document.getElementById('waMessage')?.value||'').trim().length>0;
      const hasRecipients=typeof selected!=='undefined' ? selected.size>0 : false;
      document.querySelectorAll('.wizard__step').forEach(s=>s.classList.remove('is-current','is-complete'));
      if(!hasMessage){ setStepState(1,'current'); return; }
      if(hasMessage && !hasRecipients){ setStepState(1,'complete'); setStepState(2,'current'); return; }
      setStepState(1,'complete'); setStepState(2,'complete'); setStepState(3,'current');
    }

    /* ===== WhatsApp ticks (optional helper) ===== */
    function setTickState(state='read'){
      const svg = document.querySelector('.ticks');
      if(!svg) return;
      svg.classList.remove('read');
      const path = svg.querySelector('path');
      if(state==='sent'){ path.setAttribute('d','M2 8l2 2 5-6'); svg.style.width='14px'; }
      else { path.setAttribute('d','M10.5 3.5l-4.2 6.1-2.3-2.3-.9.9 3.3 3.3L11.4 4.4l-.9-.9zM15 3.5l-4.2 6.1-.8-.8.9-.9L15 1.7l.9.9-.9.9z'); }
      if(state==='read'){ svg.classList.add('read'); }
    }

    /* ===== Your existing logic (kept) ===== */
    let currentImageUrl = null;

    function updatePreview() {
      const message = document.getElementById('waMessage').value || 'Enter your message to see preview...';
      const timeValue = document.getElementById('waTime').value || '10:45 AM';
      const previewName = document.getElementById('waPreviewName').value || 'Customer';

      // Update chat UI
      document.getElementById('receiverMessage').textContent = message;
      // WhatsApp bubble time usually 24h / short; trimming AM/PM if you want:
      const displayTime = timeValue.replace(/\s?(AM|PM)$/i,'');
      document.getElementById('receiverTime').textContent = displayTime || '10:45';
      document.getElementById('headerName').textContent = previewName;
      document.getElementById('headerAvatar').textContent = previewName.charAt(0).toUpperCase();

      localStorage.setItem('messageData', JSON.stringify({
        message, time: timeValue, imageUrl: currentImageUrl, previewName
      }));
      updateWizard();
    }

    function loadLocalImage(event) {
      const file = event.target.files[0];
      const imageElement = document.getElementById('receiverImage');

      if (file) {
        const formData = new FormData();
        formData.append('image', file);
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        fetch('/upload-image/', { method:'POST', headers:{ 'X-CSRFToken': csrfToken }, body: formData })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            currentImageUrl = data.file_url;
            imageElement.src = currentImageUrl;
            imageElement.style.display = 'block';
            updatePreview();
          } else { alert('Failed to upload image. Please try again.'); }
        })
        .catch(err => { console.error(err); alert('Error uploading image.'); });
      } else {
        imageElement.style.display = 'none';
        currentImageUrl = null;
        updatePreview();
      }
    }

    // Selection logic (uses contacts_json)
    const selected = new Set();
    const contacts = JSON.parse('{{ contacts_json|default:"[]"|escapejs }}');

    function toggleSelect(contactId) {
      const btn = document.getElementById(`selectBtn${contactId}`);
      if (selected.has(contactId)) {
        selected.delete(contactId);
        btn.classList.remove('selected'); btn.textContent = 'Select';
      } else {
        selected.add(contactId);
        btn.classList.add('selected'); btn.textContent = 'Selected';
      }
      updateSelectAllBtn(); updateWizard();
    }

    function selectAll() {
      if (selected.size === contacts.length) {
        selected.clear();
        contacts.forEach(c => { const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.remove('selected'); b.textContent='Select'; } });
      } else {
        contacts.forEach(c => { selected.add(c.id); const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.add('selected'); b.textContent='Selected'; } });
      }
      updateSelectAllBtn(); updateWizard();
    }

    function updateSelectAllBtn() {
      const btn = document.getElementById('selectAllBtn');
      if (!btn) return;
      btn.textContent = (selected.size === contacts.length && contacts.length>0) ? 'Deselect All' : 'Select All';
    }

    function sendBulkMessage() {
      if (selected.size === 0) { alert('Please select at least one recipient.'); return; }
      const message = document.getElementById('waMessage').value;
      if (!message) { alert('Please enter a message to send.'); return; }
      const time = document.getElementById('waTime').value;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

      fetch('/send-bulk/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify({ message, time, image_url: currentImageUrl, recipients: Array.from(selected) })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          // reset
          document.getElementById('waMessage').value=''; document.getElementById('waTime').value='10:45 AM';
          document.getElementById('waImageFile').value=''; const img=document.getElementById('receiverImage'); img.style.display='none';
          currentImageUrl=null; updatePreview();
          selected.clear(); contacts.forEach(c=>{ const b=document.getElementById(`selectBtn${c.id}`); if(b){ b.classList.remove('selected'); b.textContent='Select'; } });
          updateSelectAllBtn(); localStorage.removeItem('messageData');
        } else { alert('Failed to send message: ' + (data.message || 'Please try again.')); }
      })
      .catch(err => { console.error(err); alert('An error occurred while sending the message.'); });
    }

    // Hydrate on load
    (function init(){
      const data = JSON.parse(localStorage.getItem('messageData') || '{}');
      if (data.message) { document.getElementById('waMessage').value = data.message; document.getElementById('receiverMessage').textContent = data.message; }
      if (data.time) {
        document.getElementById('waTime').value = data.time;
        document.getElementById('receiverTime').textContent = (data.time||'').replace(/\s?(AM|PM)$/i,'') || '10:45';
      }
      if (data.imageUrl) { currentImageUrl = data.imageUrl; const img = document.getElementById('receiverImage'); img.src = data.imageUrl; img.style.display='block'; }
      if (data.previewName) {
        document.getElementById('waPreviewName').value = data.previewName;
        document.getElementById('headerName').textContent = data.previewName;
        document.getElementById('headerAvatar').textContent = data.previewName.charAt(0).toUpperCase();
      }
      updatePreview(); updateWizard();
    })();
  </script>
</body>
</html>
